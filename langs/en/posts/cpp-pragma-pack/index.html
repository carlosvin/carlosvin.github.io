<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../../../../favicon.png" />
		<script
			async
			src="https://cdn.jsdelivr.net/npm/@statsig/js-client@1/build/statsig-js-client+session-replay+web-analytics.min.js?apikey=client-HFdLXhoqeAqLJGsEO0FuGCieE2nSFNxpPp2ziw3ZPYK"
		></script>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="/app.css" />
		
		<link href="../../../../_app/immutable/assets/2.BkyfcBaI.css" rel="stylesheet">
		<link href="../../../../_app/immutable/assets/IconLink.2qtseSjK.css" rel="stylesheet">
		<link href="../../../../_app/immutable/assets/Social.CTdkLZ_f.css" rel="stylesheet">
		<link href="../../../../_app/immutable/assets/8.CqjetrkP.css" rel="stylesheet">
		<link href="../../../../_app/immutable/assets/Details.C_CQQSd4.css" rel="stylesheet">
		<link rel="modulepreload" href="../../../../_app/immutable/entry/start.Dg2WxSzj.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/entry.BXLEF9h2.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/runtime.3FY_vtsg.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/index-client.B1gllz1k.js">
		<link rel="modulepreload" href="../../../../_app/immutable/entry/app.DiecyXnG.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/render.CY392Wed.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/svelte-head.CPyUmzYt.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/disclose-version.B5WKJUOZ.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/3.CAhkvHRE.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/props.DBxtFyAD.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/0.hWIgE5sI.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/2.Xa-J0HUn.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/misc.8zLmL9bg.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/lifecycle.4u1WjEOg.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/IconLink.k-vueeZX.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Social.D6bLOiwf.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/8.DMK56GIg.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/url.QYYjpySO.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Details.C57OQ6iz.js"><!--[--><meta property="og:title" content="C++ Struct memory alignment"> <meta name="date.created" content="2012-11-26T11:00:00.000Z"> <meta name="date.updated" content="2012-11-26T11:00:00.000Z"> <meta name="description" content="Understanding pragma pack preprocessor directive and how it affects to memory alignment"> <meta property="og:description" content="Understanding pragma pack preprocessor directive and how it affects to memory alignment"> <meta property="og:type" content="article"> <meta property="og:url" content="http://sveltekit-prerender/langs/en/posts/cpp-pragma-pack/"> <meta property="og:locale" content="en"> <meta property="og:locale:alternate" content="es"> <meta property="og:image"> <meta property="og:article:tag" content="C++,Performance,Compilers,Memory"> <!--[--><!--[--><link rel="alternate" hreflang="es" href="/langs/es/posts/cpp-pragma-pack"><!--]--><!--]--> <!----><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"Webpage","@id":"https://google.com/article"},"headline":"C++ Struct memory alignment","alternativeHeadline":"Understanding pragma pack preprocessor directive and how it affects to memory alignment","description":"Understanding pragma pack preprocessor directive and how it affects to memory alignment","datePublished":"2012-11-26T11:00:00.000Z","dateModified":"2012-11-26T11:00:00.000Z","keywords":["C++","Performance","Compilers","Memory"],"author":{"@type":"Person","name":"Carlos Martin Sanchez"},"publisher":{"@type":"Person","name":"Carlos Martin Sanchez"}}</script><!----><!--]--><title>C++ Struct memory alignment</title>
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><!--[--><!----><nav class="svelte-pyuk6k"><ul class="svelte-pyuk6k"><li class="svelte-2j41u7"><a aria-current="page" href="/langs/en/posts" rel="prefetch" class="svelte-2j41u7"><!----><img class="logo svelte-pyuk6k" src="/favicon.25px.png" alt="Carlos Say's Bla Bla logo"><!----></a></li><!----></ul> <ul class="closed svelte-pyuk6k"><li class="svelte-2j41u7"><a aria-current="page" href="/langs/en/posts" rel="prefetch" class="svelte-2j41u7"><!----><span class="siteName">Carlos Say's Bla Bla</span><!----></a></li><!----> <li class="svelte-2j41u7"><a href="/langs/en/categories" rel="prefetch" class="svelte-2j41u7"><!----><!---->Categories<!----></a></li><!----> <li class="svelte-2j41u7"><a href="/langs/en/about" rel="prefetch" class="svelte-2j41u7"><!----><!---->About me<!----></a></li><!----></ul> <!--[--><!----><div class="h svelte-geb0ta"><!----><a href="/langs/en/feed.xml" target="_blank" class="icon rss svelte-blgowr" title="Subscribe to the feed Carlos Say's Bla Bla" rel="noopener" aria-label="Subscribe to the feed Carlos Say's Bla Bla"><!----><!----></a><!----> <a href="https://github.com/carlosvin" target="_blank" class="icon github svelte-blgowr" title="Find me at github" rel="noopener" aria-label="Find me at github"><!----><!----></a><!----> <a href="https://stackoverflow.com/users/1421059/carlosvin" target="_blank" class="icon stackoverflow svelte-blgowr" title="Find me at stackoverflow" rel="noopener" aria-label="Find me at stackoverflow"><!----><!----></a><!----></div><!----><!--]--> <button type="button" class="svelte-pyuk6k">â‰¡</button></nav><!----> <main class="svelte-qhq9sm"><!----><!----><header class="svelte-1ikjkmw"><h1 class="svelte-1ikjkmw">C++ Struct memory alignment <span class="share svelte-1ikjkmw"><!--[!--><a href="https://twitter.com/intent/tweet?url=/langs/en/posts/cpp-pragma-pack&amp;text=C++ Struct memory alignment:&amp;nbsp;Understanding pragma pack preprocessor directive and how it affects to memory alignment&amp;hashtags=C++,Performance,Compilers,Memory" target="_blank" class="icon twitter svelte-blgowr" title="Share &quot;C++ Struct memory alignment&quot;" rel="noopener" aria-label="Share &quot;C++ Struct memory alignment&quot;"><!----><!----></a><!--]--><!----></span></h1> <p class="summary svelte-1ikjkmw">Understanding pragma pack preprocessor directive and how it affects to memory alignment</p> <div class="subtitle svelte-9uod0d"><span class="date">11/26/2012</span> <span class="langs"><!--[--><ul class="otherLangs svelte-1numgf3"><!--[--><!--[--><li class="svelte-1numgf3"><a rel="alternate" hreflang="es" href="/langs/es/posts/cpp-pragma-pack" title="Check the post in other language: es">es</a></li><!--]--><!--]--></ul><!--]--><!----></span> <!--[--><span class="tags svelte-wqh6y7"><!--[--><a href="/langs/en/categories/c" title="C++" class="svelte-1g7d2s3">C++</a><a href="/langs/en/categories/performance" title="Performance" class="svelte-1g7d2s3">Performance</a><a href="/langs/en/categories/compilers" title="Compilers" class="svelte-1g7d2s3">Compilers</a><a href="/langs/en/categories/memory" title="Memory" class="svelte-1g7d2s3">Memory</a><!--]--></span><!--]--><!----></div><!----></header> <div class="postContent"><!----><div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_struct_example">Struct example</a></li>
<li><a href="#_pragma_pack_directive_in_c_struct">#pragma pack directive in C++ struct</a></li>
<li><a href="#_performance_test">Performance test</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>A C++ struct is an element that groups attributes with different types so we can manipulate them all together using same reference. It is like a class with public visibility by default for functions and attributes.</p>
</div>
<div class="paragraph">
<p>If we want to work in a lower level, closer to machine, it might be useful understand how that data structure is stored in memory and how to control that mapping.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_struct_example">Struct example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It has two attributes: an integer (4 bytes) and a boolean (1 byte).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c++" data-lang="c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SampleStruct</span>
{
    <span class="hljs-type">bool</span> flag;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timeout;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we get the instance size using <code>sizeof</code> we should get 5 bytes size and memory would be like:</p>
</div>
<div id="5-bytes" class="imageblock center">
<div class="content">
<img src="/posts/cpp-pragma-pack/5b.png" alt="5Bytes" width="200" height="auto">
</div>
<div class="title">Figure 1. 5 bytes struct which uses 5 bytes in memory</div>
</div>
<div class="paragraph">
<p><strong>But</strong> is not that simple, memory alignment depends on compiler and system. We will learn how to control compiler alignment policy, so we can avoid getting unexpected allocation memory sizes.</p>
</div>
<div class="paragraph">
<p>For example, in my local host, if I get the <code>sizeof</code> the previous structure without <code>pragma</code> declarations, <strong>I get a 8 bytes size</strong>. We are getting 8 Bytes instead of expected 5 Bytes because the compiler allocates more memory at the end of structure so it fits in 2n bytes blocks. Memory actually looks like:</p>
</div>
<div id="8-bytes" class="imageblock center">
<div class="content">
<img src="/posts/cpp-pragma-pack/8b.png" alt="5Bytes" width="200" height="auto">
</div>
<div class="title">Without pragma: 5 bytes structure that actually spends 8 bytes in memory</div>
</div>
<div class="listingblock">
<div class="title">It prints structure and attributes size, in this case <strong>4 + 1 is not 5</strong></div>
<div class="content">
<pre class="highlight"><code class="language-c++" data-lang="c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span>  <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SampleStruct</span>
{
    <span class="hljs-type">bool</span> flag;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timeout;
};

<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">print</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> sz, <span class="hljs-type">size_t</span> sz_flag, <span class="hljs-type">size_t</span> sz_timeout)</span>
</span>{
    cout &lt;&lt; <span class="hljs-string">&quot;\tflag: &quot;</span> &lt;&lt; sz_flag &lt;&lt; <span class="hljs-string">&quot; Bytes&quot;</span> &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">&quot;\t+&quot;</span> &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">&quot;\ttimeout: &quot;</span> &lt;&lt; sz_timeout &lt;&lt; <span class="hljs-string">&quot; Bytes&quot;</span> &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">&quot;\t=&quot;</span> &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">&quot;\t&quot;</span> &lt;&lt; sz_timeout + sz_flag &lt;&lt; <span class="hljs-string">&quot; Bytes&quot;</span> &lt;&lt; endl;
    cout &lt;&lt;<span class="hljs-string">&quot;sizeof struct:  &quot;</span> &lt;&lt; sz &lt;&lt; <span class="hljs-string">&quot; Bytes&quot;</span> &lt;&lt; endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span>
</span>{
    cout &lt;&lt; <span class="hljs-string">&quot;SampleStruct&quot;</span> &lt;&lt; endl;
    <span class="hljs-built_in">print</span> (<span class="hljs-built_in">sizeof</span>(SampleStruct), <span class="hljs-built_in">sizeof</span>(SampleStruct::flag), <span class="hljs-built_in">sizeof</span>(SampleStruct::timeout));
    cout &lt;&lt; <span class="hljs-string">&quot; -- &quot;</span> &lt;&lt; endl;

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><a href="https://coliru.stacked-crooked.com/a/7c18ee6585e57366">Executing code with pragma pack directive</a>: We get 8 bytes instead of 5 bytes</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">SampleStruct
flag: 1 Bytes
+
<span class="hljs-built_in">timeout</span>: 4 Bytes
=
5 Bytes
sizeof struct:  8 Bytes
--</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
If we want to know the exact structure size we have to specify compiler how to align the memory, to do so we have <code>#pragma pack(n)</code> directive.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pragma_pack_directive_in_c_struct">#pragma pack directive in C++ struct</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is a preprocessor directive to indicate to compiler how to align data in memory.</p>
</div>
<div class="listingblock">
<div class="title">Example with different memory alignment configurations</div>
<div class="content">
<pre class="highlight"><code class="language-c++" data-lang="c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">print</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> sz, <span class="hljs-type">size_t</span> sz_flag, <span class="hljs-type">size_t</span> sz_timeout)</span>
</span>{
    cout &lt;&lt; <span class="hljs-string">&quot; flag: &quot;</span> &lt;&lt; sz_flag &lt;&lt; <span class="hljs-string">&quot; Bytes&quot;</span>&lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">&quot; +&quot;</span> &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">&quot; timeout: &quot;</span> &lt;&lt; sz_timeout &lt;&lt; <span class="hljs-string">&quot;Bytes&quot;</span> &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">&quot; =&quot;</span> &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; sz_timeout + sz_flag &lt;&lt; <span class="hljs-string">&quot;Bytes&quot;</span> &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">&quot; sizeof struct:  &quot;</span> &lt;&lt; sz &lt;&lt; <span class="hljs-string">&quot; Bytes&quot;</span> &lt;&lt; endl;
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack (1)</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SampleStructPack1</span>
{
    <span class="hljs-type">bool</span> flag;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timeout;
};
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack(0)</span>

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack (2)</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SampleStructPack2</span>
{
    <span class="hljs-type">bool</span> flag;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timeout;
};
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack(0)</span>

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack (4)</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SampleStructPack4</span>
{
    <span class="hljs-type">bool</span> flag;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timeout;
};
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack(0)</span>


<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SampleStruct</span>
{
    <span class="hljs-type">bool</span> flag;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timeout;
};


<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span>
</span>{

    cout &lt;&lt; <span class="hljs-string">&quot;SampleStructPack1&quot;</span> &lt;&lt; endl;
    <span class="hljs-built_in">print</span> (<span class="hljs-built_in">sizeof</span>(SampleStructPack1), <span class="hljs-built_in">sizeof</span>(SampleStructPack1::flag), <span class="hljs-built_in">sizeof</span>(SampleStructPack1::timeout));
    cout &lt;&lt; <span class="hljs-string">&quot; -- &quot;</span> &lt;&lt; endl;

    cout &lt;&lt; <span class="hljs-string">&quot;SampleStructPack2&quot;</span> &lt;&lt; endl;
    <span class="hljs-built_in">print</span> (<span class="hljs-built_in">sizeof</span>(SampleStructPack2), <span class="hljs-built_in">sizeof</span>(SampleStructPack2::flag), <span class="hljs-built_in">sizeof</span>(SampleStructPack2::timeout));

    cout &lt;&lt; <span class="hljs-string">&quot;SampleStructPack4&quot;</span> &lt;&lt; endl;
    <span class="hljs-built_in">print</span> (<span class="hljs-built_in">sizeof</span>(SampleStructPack4), <span class="hljs-built_in">sizeof</span>(SampleStructPack4::flag), <span class="hljs-built_in">sizeof</span>(SampleStructPack4::timeout));

    cout &lt;&lt; <span class="hljs-string">&quot;SampleStruct&quot;</span> &lt;&lt; endl;
    <span class="hljs-built_in">print</span> (<span class="hljs-built_in">sizeof</span>(SampleStruct), <span class="hljs-built_in">sizeof</span>(SampleStruct::flag), <span class="hljs-built_in">sizeof</span>(SampleStruct::timeout));
    cout &lt;&lt; <span class="hljs-string">&quot; -- &quot;</span> &lt;&lt; endl;

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><a href="https://coliru.stacked-crooked.com/a/7c18ee6585e57366">Executing code with pragma pack directive</a>, we have different results depending of pragma value.</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">SampleStructPack1 <b class="conum">(1)</b>
 flag: 1 Bytes
 +
 <span class="hljs-built_in">timeout</span>: 4Bytes
 =
 5Bytes
 sizeof struct:  5 Bytes
 --

SampleStructPack2 <b class="conum">(2)</b>
 flag: 1 Bytes
 +
 <span class="hljs-built_in">timeout</span>: 4Bytes
 =
 5Bytes
 sizeof struct:  6 Bytes

SampleStructPack4 <b class="conum">(3)</b>
 flag: 1 Bytes
 +
 <span class="hljs-built_in">timeout</span>: 4Bytes
 =
 5Bytes
 sizeof struct:  8 Bytes

SampleStruct <b class="conum">(4)</b>
 flag: 1 Bytes
 +
 <span class="hljs-built_in">timeout</span>: 4Bytes
 =
 5Bytes
 sizeof struct:  8 Bytes</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>SampleStructPack1 <code>#pragma pack (1)</code>: It allocates 1 byte memory block, so our sample struct fits perfectly, in this case it is true that <code>4 + 1 = 5</code>.</p>
</li>
<li>
<p>SampleStructPack2 <code>#pragma pack (2)</code>: Minimum block size is 2 bytes. Integer attribute fits because it just needs 2 blocks of 2 Bytes. Boolean attribute needs just 1 Byte, but minimum block size is 2 Bytes, that&#8217;s why total allocated memory is 6 bytes, <code>4 + 2 = 6</code>.</p>
</li>
<li>
<p>SampleStructPack4 <code>#pragma pack (4)</code>: It is like previous one, but in this case we are wasting more memory for boolean attribute, it needs 1 Byte, but we are allocating 4 Bytes.</p>
</li>
<li>
<p>SampleStruct (default compiler alignment): As you can see it behaves exactly like <code>#pragma pack (4)</code>, so we can deduct it is the default compiler alignment.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Why don&#8217;t we always use smallest memory alignment (<code>#pragma pack (1)</code>) so we can save more memory?
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Because of performance loss.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_performance_test">Performance test</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The test will allocate same number of elements in arrays for each structure type (1, 2, 4).</p>
</div>
<div class="listingblock">
<div class="title">Test results: <a href="https://coliru.stacked-crooked.com/a/954ad542659c7591">execute performance test</a></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">SampleStructPack1: 500000000000000000 bytes allocated <span class="hljs-keyword">in</span> 94311 nanoseconds
SampleStructPack2: 600000000000000000 bytes allocated <span class="hljs-keyword">in</span> 1777 nanoseconds
SampleStructPack4: 800000000000000000 bytes allocated <span class="hljs-keyword">in</span> 1519 nanoseconds</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the smallest memory alignment spends more time allocating and releasing memory.</p>
</div>
<div class="listingblock">
<div class="title">Performance test source code:</div>
<div class="content">
<pre class="highlight"><code class="language-c++" data-lang="c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack (1)</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SampleStructPack1</span>
{
    <span class="hljs-type">bool</span> flag;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timeout;
};
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack(0)</span>

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack (2)</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SampleStructPack2</span>
{
    <span class="hljs-type">bool</span> flag;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timeout;
};
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack(0)</span>

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack (4)</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SampleStructPack4</span>
{
    <span class="hljs-type">bool</span> flag;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timeout;
};
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> pack(0)</span>


<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SampleStruct</span>
{
    <span class="hljs-type">bool</span> flag;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timeout;
};

<span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">long</span> MAX_ELEMENTS = <span class="hljs-number">100000000000000000</span>;
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std::chrono;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">allocate1</span><span class="hljs-params">()</span>
</span>{
    SampleStructPack1 elements [MAX_ELEMENTS];
    cout &lt;&lt; <span class="hljs-string">&quot;SampleStructPack1: &quot;</span> &lt;&lt; <span class="hljs-built_in">sizeof</span>(elements) &lt;&lt; <span class="hljs-string">&quot; bytes allocated&quot;</span>;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">allocate2</span><span class="hljs-params">()</span>
</span>{
    SampleStructPack2 elements [MAX_ELEMENTS];
    cout &lt;&lt; <span class="hljs-string">&quot;SampleStructPack2: &quot;</span> &lt;&lt; <span class="hljs-built_in">sizeof</span>(elements) &lt;&lt; <span class="hljs-string">&quot; bytes allocated&quot;</span>;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">allocate4</span><span class="hljs-params">()</span>
</span>{
    SampleStructPack4 elements [MAX_ELEMENTS];
    cout &lt;&lt; <span class="hljs-string">&quot;SampleStructPack4: &quot;</span> &lt;&lt; <span class="hljs-built_in">sizeof</span>(elements) &lt;&lt; <span class="hljs-string">&quot; bytes allocated&quot;</span>;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">chrono1</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">auto</span> begin = high_resolution_clock::<span class="hljs-built_in">now</span>() ;
    <span class="hljs-built_in">allocate1</span>();
    cout &lt;&lt; <span class="hljs-string">&quot; in &quot;</span> &lt;&lt; <span class="hljs-built_in">duration_cast</span>&lt;nanoseconds&gt;(high_resolution_clock::<span class="hljs-built_in">now</span>() - begin).<span class="hljs-built_in">count</span>() &lt;&lt; <span class="hljs-string">&quot; nanoseconds&quot;</span> &lt;&lt; endl;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">chrono2</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">auto</span> begin = high_resolution_clock::<span class="hljs-built_in">now</span>() ;
    <span class="hljs-built_in">allocate2</span>();
    cout &lt;&lt; <span class="hljs-string">&quot; in &quot;</span> &lt;&lt; <span class="hljs-built_in">duration_cast</span>&lt;nanoseconds&gt;(high_resolution_clock::<span class="hljs-built_in">now</span>() - begin).<span class="hljs-built_in">count</span>() &lt;&lt; <span class="hljs-string">&quot; nanoseconds&quot;</span> &lt;&lt; endl;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">chrono4</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">auto</span> begin = high_resolution_clock::<span class="hljs-built_in">now</span>() ;
    <span class="hljs-built_in">allocate4</span>();
    cout &lt;&lt; <span class="hljs-string">&quot; in &quot;</span> &lt;&lt; <span class="hljs-built_in">duration_cast</span>&lt;nanoseconds&gt;(high_resolution_clock::<span class="hljs-built_in">now</span>() - begin).<span class="hljs-built_in">count</span>() &lt;&lt; <span class="hljs-string">&quot; nanoseconds&quot;</span> &lt;&lt; endl;
}


<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span>
</span>{
    <span class="hljs-built_in">chrono1</span>();
    <span class="hljs-built_in">chrono2</span>();
    <span class="hljs-built_in">chrono4</span>();

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre>
</div>
</div>
</div>
</div><!----> <div class="comments"><script src="https://utteranc.es/client.js" repo="carlosvin/carlosvin.github.io" issue-term="title" label="comment" theme="github-light" crossorigin="anonymous" async>
	</script></div><!----></div><!----><!----><!----></main> <footer class="svelte-qhq9sm"><span>Carlos Say's Bla Bla</span> <code>1.0.1</code></footer><!----><!--]--><!----><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_1qhkr5p = {
						base: new URL("../../../..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../../../../_app/immutable/entry/start.Dg2WxSzj.js"),
						import("../../../../_app/immutable/entry/app.DiecyXnG.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 8],
							data: [null,{"type":"data","data":{path:"/langs/en/posts/cpp-pragma-pack/",lang:"en",translations:{lang:"en",author:"Carlos Martin Sanchez",siteName:"Carlos Say's Bla Bla",siteDescription:"What is going on in my mind and its surroundings",categories:"categories",Categories:"Categories",RecentPosts:"Recent posts",NoPosts:"There are no posts",SubscribeTo:"Subscribe to the feed",AboutMe:"About me",AllPosts:"All posts"},version:"1.0.1"},"uses":{"params":["lang"],"url":1},"slash":"always"},{"type":"data","data":{html:"\u003Cdiv id=\"toc\" class=\"toc\">\n\u003Cdiv id=\"toctitle\">Table of Contents\u003C/div>\n\u003Cul class=\"sectlevel1\">\n\u003Cli>\u003Ca href=\"#_struct_example\">Struct example\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#_pragma_pack_directive_in_c_struct\">#pragma pack directive in C++ struct\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#_performance_test\">Performance test\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/div>\n\u003Cdiv id=\"preamble\">\n\u003Cdiv class=\"sectionbody\">\n\u003Cdiv class=\"paragraph\">\n\u003Cp>A C++ struct is an element that groups attributes with different types so we can manipulate them all together using same reference. It is like a class with public visibility by default for functions and attributes.\u003C/p>\n\u003C/div>\n\u003Cdiv class=\"paragraph\">\n\u003Cp>If we want to work in a lower level, closer to machine, it might be useful understand how that data structure is stored in memory and how to control that mapping.\u003C/p>\n\u003C/div>\n\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"sect1\">\n\u003Ch2 id=\"_struct_example\">Struct example\u003C/h2>\n\u003Cdiv class=\"sectionbody\">\n\u003Cdiv class=\"paragraph\">\n\u003Cp>It has two attributes: an integer (4 bytes) and a boolean (1 byte).\u003C/p>\n\u003C/div>\n\u003Cdiv class=\"listingblock\">\n\u003Cdiv class=\"content\">\n\u003Cpre class=\"highlight\">\u003Ccode class=\"language-c++\" data-lang=\"c++\">\u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">SampleStruct\u003C/span>\n{\n    \u003Cspan class=\"hljs-type\">bool\u003C/span> flag;\n    \u003Cspan class=\"hljs-type\">unsigned\u003C/span> \u003Cspan class=\"hljs-type\">int\u003C/span> timeout;\n};\u003C/code>\u003C/pre>\n\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"paragraph\">\n\u003Cp>If we get the instance size using \u003Ccode>sizeof\u003C/code> we should get 5 bytes size and memory would be like:\u003C/p>\n\u003C/div>\n\u003Cdiv id=\"5-bytes\" class=\"imageblock center\">\n\u003Cdiv class=\"content\">\n\u003Cimg src=\"/posts/cpp-pragma-pack/5b.png\" alt=\"5Bytes\" width=\"200\" height=\"auto\">\n\u003C/div>\n\u003Cdiv class=\"title\">Figure 1. 5 bytes struct which uses 5 bytes in memory\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"paragraph\">\n\u003Cp>\u003Cstrong>But\u003C/strong> is not that simple, memory alignment depends on compiler and system. We will learn how to control compiler alignment policy, so we can avoid getting unexpected allocation memory sizes.\u003C/p>\n\u003C/div>\n\u003Cdiv class=\"paragraph\">\n\u003Cp>For example, in my local host, if I get the \u003Ccode>sizeof\u003C/code> the previous structure without \u003Ccode>pragma\u003C/code> declarations, \u003Cstrong>I get a 8 bytes size\u003C/strong>. We are getting 8 Bytes instead of expected 5 Bytes because the compiler allocates more memory at the end of structure so it fits in 2n bytes blocks. Memory actually looks like:\u003C/p>\n\u003C/div>\n\u003Cdiv id=\"8-bytes\" class=\"imageblock center\">\n\u003Cdiv class=\"content\">\n\u003Cimg src=\"/posts/cpp-pragma-pack/8b.png\" alt=\"5Bytes\" width=\"200\" height=\"auto\">\n\u003C/div>\n\u003Cdiv class=\"title\">Without pragma: 5 bytes structure that actually spends 8 bytes in memory\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"listingblock\">\n\u003Cdiv class=\"title\">It prints structure and attributes size, in this case \u003Cstrong>4 + 1 is not 5\u003C/strong>\u003C/div>\n\u003Cdiv class=\"content\">\n\u003Cpre class=\"highlight\">\u003Ccode class=\"language-c++\" data-lang=\"c++\">\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">include\u003C/span>  \u003Cspan class=\"hljs-string\">&lt;iostream&gt;\u003C/span>\u003C/span>\n\n\u003Cspan class=\"hljs-keyword\">using\u003C/span> \u003Cspan class=\"hljs-keyword\">namespace\u003C/span> std;\n\n\u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">SampleStruct\u003C/span>\n{\n    \u003Cspan class=\"hljs-type\">bool\u003C/span> flag;\n    \u003Cspan class=\"hljs-type\">unsigned\u003C/span> \u003Cspan class=\"hljs-type\">int\u003C/span> timeout;\n};\n\n\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-type\">static\u003C/span> \u003Cspan class=\"hljs-type\">void\u003C/span> \u003Cspan class=\"hljs-title\">print\u003C/span> \u003Cspan class=\"hljs-params\">(\u003Cspan class=\"hljs-type\">size_t\u003C/span> sz, \u003Cspan class=\"hljs-type\">size_t\u003C/span> sz_flag, \u003Cspan class=\"hljs-type\">size_t\u003C/span> sz_timeout)\u003C/span>\n\u003C/span>{\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;\\tflag: &quot;\u003C/span> &lt;&lt; sz_flag &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; Bytes&quot;\u003C/span> &lt;&lt; endl;\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;\\t+&quot;\u003C/span> &lt;&lt; endl;\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;\\ttimeout: &quot;\u003C/span> &lt;&lt; sz_timeout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; Bytes&quot;\u003C/span> &lt;&lt; endl;\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;\\t=&quot;\u003C/span> &lt;&lt; endl;\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;\\t&quot;\u003C/span> &lt;&lt; sz_timeout + sz_flag &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; Bytes&quot;\u003C/span> &lt;&lt; endl;\n    cout &lt;&lt;\u003Cspan class=\"hljs-string\">&quot;sizeof struct:  &quot;\u003C/span> &lt;&lt; sz &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; Bytes&quot;\u003C/span> &lt;&lt; endl;\n}\n\n\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-type\">int\u003C/span> \u003Cspan class=\"hljs-title\">main\u003C/span>\u003Cspan class=\"hljs-params\">(\u003Cspan class=\"hljs-type\">int\u003C/span> argc, \u003Cspan class=\"hljs-type\">char\u003C/span> *argv[])\u003C/span>\n\u003C/span>{\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;SampleStruct&quot;\u003C/span> &lt;&lt; endl;\n    \u003Cspan class=\"hljs-built_in\">print\u003C/span> (\u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStruct), \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStruct::flag), \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStruct::timeout));\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; -- &quot;\u003C/span> &lt;&lt; endl;\n\n    \u003Cspan class=\"hljs-keyword\">return\u003C/span> \u003Cspan class=\"hljs-number\">0\u003C/span>;\n}\u003C/code>\u003C/pre>\n\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"listingblock\">\n\u003Cdiv class=\"title\">\u003Ca href=\"https://coliru.stacked-crooked.com/a/7c18ee6585e57366\">Executing code with pragma pack directive\u003C/a>: We get 8 bytes instead of 5 bytes\u003C/div>\n\u003Cdiv class=\"content\">\n\u003Cpre class=\"highlight\">\u003Ccode class=\"language-bash\" data-lang=\"bash\">SampleStruct\nflag: 1 Bytes\n+\n\u003Cspan class=\"hljs-built_in\">timeout\u003C/span>: 4 Bytes\n=\n5 Bytes\nsizeof struct:  8 Bytes\n--\u003C/code>\u003C/pre>\n\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"admonitionblock tip\">\n\u003Ctable>\n\u003Ctr>\n\u003Ctd class=\"icon\">\n\u003Cdiv class=\"title\">Tip\u003C/div>\n\u003C/td>\n\u003Ctd class=\"content\">\nIf we want to know the exact structure size we have to specify compiler how to align the memory, to do so we have \u003Ccode>#pragma pack(n)\u003C/code> directive.\n\u003C/td>\n\u003C/tr>\n\u003C/table>\n\u003C/div>\n\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"sect1\">\n\u003Ch2 id=\"_pragma_pack_directive_in_c_struct\">#pragma pack directive in C++ struct\u003C/h2>\n\u003Cdiv class=\"sectionbody\">\n\u003Cdiv class=\"paragraph\">\n\u003Cp>It is a preprocessor directive to indicate to compiler how to align data in memory.\u003C/p>\n\u003C/div>\n\u003Cdiv class=\"listingblock\">\n\u003Cdiv class=\"title\">Example with different memory alignment configurations\u003C/div>\n\u003Cdiv class=\"content\">\n\u003Cpre class=\"highlight\">\u003Ccode class=\"language-c++\" data-lang=\"c++\">\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">include\u003C/span> \u003Cspan class=\"hljs-string\">&lt;iostream&gt;\u003C/span>\u003C/span>\n\n\u003Cspan class=\"hljs-keyword\">using\u003C/span> \u003Cspan class=\"hljs-keyword\">namespace\u003C/span> std;\n\n\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-type\">static\u003C/span> \u003Cspan class=\"hljs-type\">void\u003C/span> \u003Cspan class=\"hljs-title\">print\u003C/span> \u003Cspan class=\"hljs-params\">(\u003Cspan class=\"hljs-type\">size_t\u003C/span> sz, \u003Cspan class=\"hljs-type\">size_t\u003C/span> sz_flag, \u003Cspan class=\"hljs-type\">size_t\u003C/span> sz_timeout)\u003C/span>\n\u003C/span>{\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; flag: &quot;\u003C/span> &lt;&lt; sz_flag &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; Bytes&quot;\u003C/span>&lt;&lt; endl;\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; +&quot;\u003C/span> &lt;&lt; endl;\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; timeout: &quot;\u003C/span> &lt;&lt; sz_timeout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;Bytes&quot;\u003C/span> &lt;&lt; endl;\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; =&quot;\u003C/span> &lt;&lt; endl;\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; &quot;\u003C/span> &lt;&lt; sz_timeout + sz_flag &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;Bytes&quot;\u003C/span> &lt;&lt; endl;\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; sizeof struct:  &quot;\u003C/span> &lt;&lt; sz &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; Bytes&quot;\u003C/span> &lt;&lt; endl;\n}\n\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack (1)\u003C/span>\n\u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">SampleStructPack1\u003C/span>\n{\n    \u003Cspan class=\"hljs-type\">bool\u003C/span> flag;\n    \u003Cspan class=\"hljs-type\">unsigned\u003C/span> \u003Cspan class=\"hljs-type\">int\u003C/span> timeout;\n};\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack(0)\u003C/span>\n\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack (2)\u003C/span>\n\u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">SampleStructPack2\u003C/span>\n{\n    \u003Cspan class=\"hljs-type\">bool\u003C/span> flag;\n    \u003Cspan class=\"hljs-type\">unsigned\u003C/span> \u003Cspan class=\"hljs-type\">int\u003C/span> timeout;\n};\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack(0)\u003C/span>\n\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack (4)\u003C/span>\n\u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">SampleStructPack4\u003C/span>\n{\n    \u003Cspan class=\"hljs-type\">bool\u003C/span> flag;\n    \u003Cspan class=\"hljs-type\">unsigned\u003C/span> \u003Cspan class=\"hljs-type\">int\u003C/span> timeout;\n};\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack(0)\u003C/span>\n\n\n\u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">SampleStruct\u003C/span>\n{\n    \u003Cspan class=\"hljs-type\">bool\u003C/span> flag;\n    \u003Cspan class=\"hljs-type\">unsigned\u003C/span> \u003Cspan class=\"hljs-type\">int\u003C/span> timeout;\n};\n\n\n\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-type\">int\u003C/span> \u003Cspan class=\"hljs-title\">main\u003C/span>\u003Cspan class=\"hljs-params\">(\u003Cspan class=\"hljs-type\">int\u003C/span> argc, \u003Cspan class=\"hljs-type\">char\u003C/span> *argv[])\u003C/span>\n\u003C/span>{\n\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;SampleStructPack1&quot;\u003C/span> &lt;&lt; endl;\n    \u003Cspan class=\"hljs-built_in\">print\u003C/span> (\u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStructPack1), \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStructPack1::flag), \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStructPack1::timeout));\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; -- &quot;\u003C/span> &lt;&lt; endl;\n\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;SampleStructPack2&quot;\u003C/span> &lt;&lt; endl;\n    \u003Cspan class=\"hljs-built_in\">print\u003C/span> (\u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStructPack2), \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStructPack2::flag), \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStructPack2::timeout));\n\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;SampleStructPack4&quot;\u003C/span> &lt;&lt; endl;\n    \u003Cspan class=\"hljs-built_in\">print\u003C/span> (\u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStructPack4), \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStructPack4::flag), \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStructPack4::timeout));\n\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;SampleStruct&quot;\u003C/span> &lt;&lt; endl;\n    \u003Cspan class=\"hljs-built_in\">print\u003C/span> (\u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStruct), \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStruct::flag), \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(SampleStruct::timeout));\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; -- &quot;\u003C/span> &lt;&lt; endl;\n\n    \u003Cspan class=\"hljs-keyword\">return\u003C/span> \u003Cspan class=\"hljs-number\">0\u003C/span>;\n}\u003C/code>\u003C/pre>\n\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"listingblock\">\n\u003Cdiv class=\"title\">\u003Ca href=\"https://coliru.stacked-crooked.com/a/7c18ee6585e57366\">Executing code with pragma pack directive\u003C/a>, we have different results depending of pragma value.\u003C/div>\n\u003Cdiv class=\"content\">\n\u003Cpre class=\"highlight\">\u003Ccode class=\"language-bash\" data-lang=\"bash\">SampleStructPack1 \u003Cb class=\"conum\">(1)\u003C/b>\n flag: 1 Bytes\n +\n \u003Cspan class=\"hljs-built_in\">timeout\u003C/span>: 4Bytes\n =\n 5Bytes\n sizeof struct:  5 Bytes\n --\n\nSampleStructPack2 \u003Cb class=\"conum\">(2)\u003C/b>\n flag: 1 Bytes\n +\n \u003Cspan class=\"hljs-built_in\">timeout\u003C/span>: 4Bytes\n =\n 5Bytes\n sizeof struct:  6 Bytes\n\nSampleStructPack4 \u003Cb class=\"conum\">(3)\u003C/b>\n flag: 1 Bytes\n +\n \u003Cspan class=\"hljs-built_in\">timeout\u003C/span>: 4Bytes\n =\n 5Bytes\n sizeof struct:  8 Bytes\n\nSampleStruct \u003Cb class=\"conum\">(4)\u003C/b>\n flag: 1 Bytes\n +\n \u003Cspan class=\"hljs-built_in\">timeout\u003C/span>: 4Bytes\n =\n 5Bytes\n sizeof struct:  8 Bytes\u003C/code>\u003C/pre>\n\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"colist arabic\">\n\u003Col>\n\u003Cli>\n\u003Cp>SampleStructPack1 \u003Ccode>#pragma pack (1)\u003C/code>: It allocates 1 byte memory block, so our sample struct fits perfectly, in this case it is true that \u003Ccode>4 + 1 = 5\u003C/code>.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>SampleStructPack2 \u003Ccode>#pragma pack (2)\u003C/code>: Minimum block size is 2 bytes. Integer attribute fits because it just needs 2 blocks of 2 Bytes. Boolean attribute needs just 1 Byte, but minimum block size is 2 Bytes, that&#8217;s why total allocated memory is 6 bytes, \u003Ccode>4 + 2 = 6\u003C/code>.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>SampleStructPack4 \u003Ccode>#pragma pack (4)\u003C/code>: It is like previous one, but in this case we are wasting more memory for boolean attribute, it needs 1 Byte, but we are allocating 4 Bytes.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>SampleStruct (default compiler alignment): As you can see it behaves exactly like \u003Ccode>#pragma pack (4)\u003C/code>, so we can deduct it is the default compiler alignment.\u003C/p>\n\u003C/li>\n\u003C/ol>\n\u003C/div>\n\u003Cdiv class=\"admonitionblock important\">\n\u003Ctable>\n\u003Ctr>\n\u003Ctd class=\"icon\">\n\u003Cdiv class=\"title\">Important\u003C/div>\n\u003C/td>\n\u003Ctd class=\"content\">\nWhy don&#8217;t we always use smallest memory alignment (\u003Ccode>#pragma pack (1)\u003C/code>) so we can save more memory?\n\u003C/td>\n\u003C/tr>\n\u003C/table>\n\u003C/div>\n\u003Cdiv class=\"admonitionblock warning\">\n\u003Ctable>\n\u003Ctr>\n\u003Ctd class=\"icon\">\n\u003Cdiv class=\"title\">Warning\u003C/div>\n\u003C/td>\n\u003Ctd class=\"content\">\nBecause of performance loss.\n\u003C/td>\n\u003C/tr>\n\u003C/table>\n\u003C/div>\n\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"sect1\">\n\u003Ch2 id=\"_performance_test\">Performance test\u003C/h2>\n\u003Cdiv class=\"sectionbody\">\n\u003Cdiv class=\"paragraph\">\n\u003Cp>The test will allocate same number of elements in arrays for each structure type (1, 2, 4).\u003C/p>\n\u003C/div>\n\u003Cdiv class=\"listingblock\">\n\u003Cdiv class=\"title\">Test results: \u003Ca href=\"https://coliru.stacked-crooked.com/a/954ad542659c7591\">execute performance test\u003C/a>\u003C/div>\n\u003Cdiv class=\"content\">\n\u003Cpre class=\"highlight\">\u003Ccode class=\"language-bash\" data-lang=\"bash\">SampleStructPack1: 500000000000000000 bytes allocated \u003Cspan class=\"hljs-keyword\">in\u003C/span> 94311 nanoseconds\nSampleStructPack2: 600000000000000000 bytes allocated \u003Cspan class=\"hljs-keyword\">in\u003C/span> 1777 nanoseconds\nSampleStructPack4: 800000000000000000 bytes allocated \u003Cspan class=\"hljs-keyword\">in\u003C/span> 1519 nanoseconds\u003C/code>\u003C/pre>\n\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"paragraph\">\n\u003Cp>As you can see, the smallest memory alignment spends more time allocating and releasing memory.\u003C/p>\n\u003C/div>\n\u003Cdiv class=\"listingblock\">\n\u003Cdiv class=\"title\">Performance test source code:\u003C/div>\n\u003Cdiv class=\"content\">\n\u003Cpre class=\"highlight\">\u003Ccode class=\"language-c++\" data-lang=\"c++\">\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">include\u003C/span> \u003Cspan class=\"hljs-string\">&lt;iostream&gt;\u003C/span>\u003C/span>\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">include\u003C/span> \u003Cspan class=\"hljs-string\">&lt;chrono&gt;\u003C/span>\u003C/span>\n\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack (1)\u003C/span>\n\u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">SampleStructPack1\u003C/span>\n{\n    \u003Cspan class=\"hljs-type\">bool\u003C/span> flag;\n    \u003Cspan class=\"hljs-type\">unsigned\u003C/span> \u003Cspan class=\"hljs-type\">int\u003C/span> timeout;\n};\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack(0)\u003C/span>\n\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack (2)\u003C/span>\n\u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">SampleStructPack2\u003C/span>\n{\n    \u003Cspan class=\"hljs-type\">bool\u003C/span> flag;\n    \u003Cspan class=\"hljs-type\">unsigned\u003C/span> \u003Cspan class=\"hljs-type\">int\u003C/span> timeout;\n};\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack(0)\u003C/span>\n\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack (4)\u003C/span>\n\u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">SampleStructPack4\u003C/span>\n{\n    \u003Cspan class=\"hljs-type\">bool\u003C/span> flag;\n    \u003Cspan class=\"hljs-type\">unsigned\u003C/span> \u003Cspan class=\"hljs-type\">int\u003C/span> timeout;\n};\n\u003Cspan class=\"hljs-meta\">#\u003Cspan class=\"hljs-keyword\">pragma\u003C/span> pack(0)\u003C/span>\n\n\n\u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">SampleStruct\u003C/span>\n{\n    \u003Cspan class=\"hljs-type\">bool\u003C/span> flag;\n    \u003Cspan class=\"hljs-type\">unsigned\u003C/span> \u003Cspan class=\"hljs-type\">int\u003C/span> timeout;\n};\n\n\u003Cspan class=\"hljs-type\">static\u003C/span> \u003Cspan class=\"hljs-type\">const\u003C/span> \u003Cspan class=\"hljs-type\">long\u003C/span> MAX_ELEMENTS = \u003Cspan class=\"hljs-number\">100000000000000000\u003C/span>;\n\u003Cspan class=\"hljs-keyword\">using\u003C/span> \u003Cspan class=\"hljs-keyword\">namespace\u003C/span> std;\n\u003Cspan class=\"hljs-keyword\">using\u003C/span> \u003Cspan class=\"hljs-keyword\">namespace\u003C/span> std::chrono;\n\n\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-type\">void\u003C/span> \u003Cspan class=\"hljs-title\">allocate1\u003C/span>\u003Cspan class=\"hljs-params\">()\u003C/span>\n\u003C/span>{\n    SampleStructPack1 elements [MAX_ELEMENTS];\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;SampleStructPack1: &quot;\u003C/span> &lt;&lt; \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(elements) &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; bytes allocated&quot;\u003C/span>;\n}\n\n\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-type\">void\u003C/span> \u003Cspan class=\"hljs-title\">allocate2\u003C/span>\u003Cspan class=\"hljs-params\">()\u003C/span>\n\u003C/span>{\n    SampleStructPack2 elements [MAX_ELEMENTS];\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;SampleStructPack2: &quot;\u003C/span> &lt;&lt; \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(elements) &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; bytes allocated&quot;\u003C/span>;\n}\n\n\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-type\">void\u003C/span> \u003Cspan class=\"hljs-title\">allocate4\u003C/span>\u003Cspan class=\"hljs-params\">()\u003C/span>\n\u003C/span>{\n    SampleStructPack4 elements [MAX_ELEMENTS];\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot;SampleStructPack4: &quot;\u003C/span> &lt;&lt; \u003Cspan class=\"hljs-built_in\">sizeof\u003C/span>(elements) &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; bytes allocated&quot;\u003C/span>;\n}\n\n\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-type\">void\u003C/span> \u003Cspan class=\"hljs-title\">chrono1\u003C/span>\u003Cspan class=\"hljs-params\">()\u003C/span>\n\u003C/span>{\n    \u003Cspan class=\"hljs-keyword\">auto\u003C/span> begin = high_resolution_clock::\u003Cspan class=\"hljs-built_in\">now\u003C/span>() ;\n    \u003Cspan class=\"hljs-built_in\">allocate1\u003C/span>();\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; in &quot;\u003C/span> &lt;&lt; \u003Cspan class=\"hljs-built_in\">duration_cast\u003C/span>&lt;nanoseconds&gt;(high_resolution_clock::\u003Cspan class=\"hljs-built_in\">now\u003C/span>() - begin).\u003Cspan class=\"hljs-built_in\">count\u003C/span>() &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; nanoseconds&quot;\u003C/span> &lt;&lt; endl;\n}\n\n\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-type\">void\u003C/span> \u003Cspan class=\"hljs-title\">chrono2\u003C/span>\u003Cspan class=\"hljs-params\">()\u003C/span>\n\u003C/span>{\n    \u003Cspan class=\"hljs-keyword\">auto\u003C/span> begin = high_resolution_clock::\u003Cspan class=\"hljs-built_in\">now\u003C/span>() ;\n    \u003Cspan class=\"hljs-built_in\">allocate2\u003C/span>();\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; in &quot;\u003C/span> &lt;&lt; \u003Cspan class=\"hljs-built_in\">duration_cast\u003C/span>&lt;nanoseconds&gt;(high_resolution_clock::\u003Cspan class=\"hljs-built_in\">now\u003C/span>() - begin).\u003Cspan class=\"hljs-built_in\">count\u003C/span>() &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; nanoseconds&quot;\u003C/span> &lt;&lt; endl;\n}\n\n\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-type\">void\u003C/span> \u003Cspan class=\"hljs-title\">chrono4\u003C/span>\u003Cspan class=\"hljs-params\">()\u003C/span>\n\u003C/span>{\n    \u003Cspan class=\"hljs-keyword\">auto\u003C/span> begin = high_resolution_clock::\u003Cspan class=\"hljs-built_in\">now\u003C/span>() ;\n    \u003Cspan class=\"hljs-built_in\">allocate4\u003C/span>();\n    cout &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; in &quot;\u003C/span> &lt;&lt; \u003Cspan class=\"hljs-built_in\">duration_cast\u003C/span>&lt;nanoseconds&gt;(high_resolution_clock::\u003Cspan class=\"hljs-built_in\">now\u003C/span>() - begin).\u003Cspan class=\"hljs-built_in\">count\u003C/span>() &lt;&lt; \u003Cspan class=\"hljs-string\">&quot; nanoseconds&quot;\u003C/span> &lt;&lt; endl;\n}\n\n\n\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-type\">int\u003C/span> \u003Cspan class=\"hljs-title\">main\u003C/span>\u003Cspan class=\"hljs-params\">(\u003Cspan class=\"hljs-type\">int\u003C/span> argc, \u003Cspan class=\"hljs-type\">char\u003C/span> *argv[])\u003C/span>\n\u003C/span>{\n    \u003Cspan class=\"hljs-built_in\">chrono1\u003C/span>();\n    \u003Cspan class=\"hljs-built_in\">chrono2\u003C/span>();\n    \u003Cspan class=\"hljs-built_in\">chrono4\u003C/span>();\n\n    \u003Cspan class=\"hljs-keyword\">return\u003C/span> \u003Cspan class=\"hljs-number\">0\u003C/span>;\n}\u003C/code>\u003C/pre>\n\u003C/div>\n\u003C/div>\n\u003C/div>\n\u003C/div>",props:{title:"C++ Struct memory alignment",lang:"en",summary:"Understanding pragma pack preprocessor directive and how it affects to memory alignment",slug:"cpp-pragma-pack",keywords:["C++","Performance","Compilers","Memory"],filepath:"/static/posts/cpp-pragma-pack/cpp-pragma-pack.en.adoc",dirpath:"/static/posts/cpp-pragma-pack",created:1353927600000,modified:1353927600000,otherLangs:["es"],author:"Carlos Martin Sanchez",previewimage:void 0,path:"/langs/en/posts/cpp-pragma-pack"},jsonLd:"\u003Cscript type=\"application/ld+json\">{\"@context\":\"https://schema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"Webpage\",\"@id\":\"https://google.com/article\"},\"headline\":\"C++ Struct memory alignment\",\"alternativeHeadline\":\"Understanding pragma pack preprocessor directive and how it affects to memory alignment\",\"description\":\"Understanding pragma pack preprocessor directive and how it affects to memory alignment\",\"datePublished\":\"2012-11-26T11:00:00.000Z\",\"dateModified\":\"2012-11-26T11:00:00.000Z\",\"keywords\":[\"C++\",\"Performance\",\"Compilers\",\"Memory\"],\"author\":{\"@type\":\"Person\",\"name\":\"Carlos Martin Sanchez\"},\"publisher\":{\"@type\":\"Person\",\"name\":\"Carlos Martin Sanchez\"}}\u003C/script>"},"uses":{"params":["slug","lang"]}}],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
