<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <meta content=sapper name=generator> <meta content=a22af7614c96254d name=yandex-verification> <link href=/icons/icon-192x192.png rel=apple-touch-icon> <base href=/ > <link href=global.css rel=stylesheet> <link href=manifest.json rel=manifest crossorigin=use-credentials> <link href=favicon.png rel=icon type=image/png> <link href=client/main.142160484.css rel=stylesheet> <noscript id=sapper-head-start></noscript><title>Example how to create custom Maven Plugin</title><link href=/rss rel=alternate type=application/rss+xml title="Subscribe to Carlos says bla bla"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"Webpage","@id":"https://google.com/article"},"headline":"Example how to create custom Maven Plugin","alternativeHeadline":"Example to understand Maven plugins concepts and how to create a custom Maven plugin from scratch","description":"Example to understand Maven plugins concepts and how to create a custom Maven plugin from scratch","image":"icons/icon-192x192.png","datePublished":"2018-03-11 19:00:00","dateModified":"2018-03-11 19:00:00","keywords":["Maven","Java","Build Systems","maven-site-plugin","Maven Plugins"],"author":{"@type":"Person","name":"Carlos Martin Sanchez"},"publisher":"Carlos Martin Sanchez"}</script><meta content=2018-03-11 name=date scheme=YYYY-MM-DD><meta content="Example to understand Maven plugins concepts and how to create a custom Maven plugin from scratch" name=description><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css rel=preload as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css rel=stylesheet></noscript><noscript id=sapper-head-end></noscript> </head> <body> <div id=sapper> <nav class=svelte-1hjvhrx><ul class=svelte-1hjvhrx><li class=svelte-1y8uoef><a href=/ class=svelte-1y8uoef><img alt="Carlos says bla bla" class="svelte-1hjvhrx logo" src=/favicon.png></a></ul> <ul class="svelte-1hjvhrx closed"><li class=svelte-1y8uoef><a href=/ class=svelte-1y8uoef><span class="svelte-1hjvhrx siteName">Carlos says bla bla</span></a></li> <li class=svelte-1y8uoef><a href=/categories class=svelte-1y8uoef>Categories</a></li> <li class=svelte-1y8uoef><a href=/about class=svelte-1y8uoef>About</a></ul> <div class="h svelte-1w8skyw"><a href=/rss rel=noopener target=_blank class="icon svelte-1lu397 rss" title="Subscribe to Carlos says bla bla"></a> <a href=https://github.com/carlosvin rel=noopener target=_blank class="icon svelte-1lu397 github" title="Find me at github"></a> <a href=https://twitter.com/carlosvin rel=noopener target=_blank class="icon svelte-1lu397 twitter" title="Find me at twitter"></a> <a href=https://stackoverflow.com/story/carlosvin rel=noopener target=_blank class="icon svelte-1lu397 stackoverflow" title="Find me at stackoverflow"></a></div> <button class=svelte-1hjvhrx>≡</button></nav> <main class=svelte-bvcji9> <header class=svelte-1svctju><h1 class=svelte-1svctju>Example how to create custom Maven Plugin <span class="svelte-1svctju share"><a href="https://twitter.com/intent/tweet?url=https://carlosvin.github.io/posts/creating-custom-maven-plugin/en&text=Example how to create custom Maven Plugin: Example to understand Maven plugins concepts and how to create a custom Maven plugin from scratch&hashtags=Maven,Java,Build Systems,maven-site-plugin,Maven Plugins" rel=noopener target=_blank class="icon svelte-1lu397 twitter" title='Share "Example how to create custom Maven Plugin"'></a></span></h1> <p class="svelte-1svctju summary">Example to understand Maven plugins concepts and how to create a custom Maven plugin from scratch</p> <div class="subtitle svelte-16mbbpz"><span class=date>11/03/2018</span> <span class=svelte-16xp99e><a href=/categories/maven class=svelte-1gu8b1d title=Maven><span class="hover svelte-1x4e0dt">Maven</span></a><a href=/categories/java class=svelte-1gu8b1d title=Java><span class="hover svelte-1x4e0dt">Java</span></a><a href=/categories/build-systems class=svelte-1gu8b1d title="Build Systems"><span class="hover svelte-1x4e0dt">Build Systems</span></a><a href=/categories/maven-site-plugin class=svelte-1gu8b1d title=maven-site-plugin><span class="hover svelte-1x4e0dt">maven-site-plugin</span></a><a href=/categories/maven-plugins class=svelte-1gu8b1d title="Maven Plugins"><span class="hover svelte-1x4e0dt">Maven Plugins</span></a></span></div></header> <div class="content svelte-1y0955x"><div class=toc id=toc> <div id=toctitle>Table of Contents</div> <ul class=sectlevel1> <li><a href=#_maven_plugin_concepts>Maven plugin concepts</a></li> <li><a href=#_create_your_custom_plugin_site_lifecycle>Create your custom plugin (Site Lifecycle)</a> <ul class=sectlevel2> <li><a href=#_project_structure>Project structure</a></li> <li><a href=#_dependency_injection>Dependency Injection</a></li> <li><a href=#_write_a_custom_mojo>Write a custom Mojo</a></li> </ul> </li> <li><a href=#_unit_tests>Unit tests</a></li> <li><a href=#_integration_tests>Integration tests</a> <ul class=sectlevel2> <li><a href=#_how_does_invoker_plugin_work>How does Invoker Plugin work?</a></li> <li><a href=#_configure_invoker_plugin>Configure Invoker Plugin</a></li> <li><a href=#_create_an_integration_test_project>Create an Integration Test Project</a></li> </ul> </li> </ul> </div> <div id=preamble> <div class=sectionbody> <div class=paragraph> <p>Maven has lots of plugins to assist you in project construction, testing, packaging and deployment. For example if you want to compile C++ code instead of Java, you can use <a href=https://www.mojohaus.org/maven-native/native-maven-plugin/ >native-maven-plugin</a>. But what if you need something more specific? Then you can create a custom Maven plugin.</p> </div> <div class=paragraph> <p>I will explain how to create a simple custom maven plugin to generate static blog site from Markdown files. I know we can already do that with <a href=https://maven.apache.org/plugins/maven-site-plugin/examples/creating-content.html>maven-site-plugin</a> since version 3.3, I will just use it for learning purposes.</p> </div> <div class=paragraph> <p>You can find the source code of this example at <a href=https://github.com/carlosvin/blog-maven-plugin class=bare>https://github.com/carlosvin/blog-maven-plugin</a>.</p> </div> </div> </div> <div class=sect1> <h2 id=_maven_plugin_concepts>Maven plugin concepts</h2> <div class=sectionbody> <div class=dlist> <dl> <dt class=hdlist1><a href=https://maven.apache.org/plugin-developers/index.html rel=noopener target=_blank>Mojo</a></dt> <dd> <p>An executable goal in Maven, e.g: <code>mvn your-plugin:your-mojo</code> will execute a maven goal <code>your-mojo</code> declared as part of <code>your-plugin</code>.</p> </dd> <dt class=hdlist1>Goal</dt> <dd> <p>It is equivalent to <a href=https://maven.apache.org/plugin-developers/index.html rel=noopener target=_blank>Mojo</a> execution.</p> </dd> <dt class=hdlist1>Lifecycle</dt> <dd> <p>It is a well-defined sequence of phases. Each phase consists of a sequence of goals. Let’s see an example of lifecycle, e.g: <code>FooLifecycle</code> has <code>clean</code>, <code>prepare</code> and <code>assemble</code> phases. Each of those phases has one of more goals. <strong>FooLifecycle</strong>:</p> <div class=dlist> <dl> <dt class=hdlist1>clean</dt> <dd> <div class=dlist> <dl> <dt class=hdlist1><strong>rmSources</strong></dt> <dd> <p>a goal to remove source files</p> </dd> <dt class=hdlist1><strong>rmBuild</strong></dt> <dd> <p>a goal to remove files in cache directory</p> </dd> </dl> </div> </dd> <dt class=hdlist1>prepare</dt> <dd> <div class=dlist> <dl> <dt class=hdlist1><strong>installDependencies</strong></dt> <dd> <p>a goal to download dependencies for the project</p> </dd> </dl> </div> </dd> <dt class=hdlist1>assemble</dt> <dd> <div class=dlist> <dl> <dt class=hdlist1><strong>build</strong></dt> <dd> <p>a goal to compile source files</p> </dd> </dl> </div> </dd> </dl> </div> </dd> </dl> </div> <div class=paragraph> <p>To define a custom life-cycle similar to previous one, we will use <code>src/main/resources/META-INF/plexus/components.xml</code>, we will speak about that file in following sections. Normally is enough to override <a href=https://maven.apache.org/ref/3.5.3/maven-core/lifecycles.html>predefined lifecycles</a>, in this example, we will override <strong>site life-cycle</strong>.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class=icon> <div class=title>Tip</div> </td> <td class=content> You can find an introduction to Maven life-cycles at <a href=https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html class=bare>https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html</a> </td> </tr> </table> </div> </div> </div> <div class=sect1> <h2 id=_create_your_custom_plugin_site_lifecycle>Create your custom plugin (Site Lifecycle)</h2> <div class=sectionbody> <div class=paragraph> <p>The plugin we are about to explain will <a href=https://maven.apache.org/ref/3.5.3/maven-core/lifecycles.html#site_Lifecycle>override site lifecycle</a>, which has only 2 default phases, so when we run <code>mvn site</code> using our new custom plugin it will execute the goals we are about to create.</p> </div> <div class=paragraph> <p>Our plugin will work with <code>md</code> (for <a href=https://commonmark.org/ rel=noopener target=_blank>Markdown</a>) file bindings: It will build and deploy the project using <a href=https://maven.apache.org/plugins/maven-deploy-plugin/ >maven deployment plugin</a>.</p> </div> <div class=sect2> <h3 id=_project_structure>Project structure</h3> <div class=dlist> <dl> <dt class=hdlist1><code>src/main/java</code></dt> <dd> <p>Where Java source code is</p> </dd> <dt class=hdlist1><code>src/main/resources/META-INF/plexus/components.xml</code></dt> <dd> <p>file to create/override maven lifecycles and artifact types. Here we can specify which goals will be executed when for an artifact type, for example, we can say that for an artifact of type <code>whatever</code> when we run <code>mvn foo</code> it will verify the files, run tests, run linter, compile and zip al generated files.</p> </dd> <dt class=hdlist1><code>src/test/java</code></dt> <dd> <p>Unit tests folder.</p> </dd> <dt class=hdlist1><code>src/it</code></dt> <dd> <p>Folder with all integration tests. Those integration tests are running actual projects and checking that outputs are as expected.</p> </dd> <dt class=hdlist1><code>pom.xml</code></dt> <dd> <p>File to with Maven project description <a href=https://maven.apache.org/guides/introduction/introduction-to-the-pom.html>(Project Object Model)</a></p> </dd> </dl> </div> </div> <div class=sect2> <h3 id=_dependency_injection>Dependency Injection</h3> <div class=paragraph> <p>Maven has finally chosen <a href=https://maven.apache.org/maven-jsr330.html rel=noopener target=_blank>JSR-330</a> as <a href=https://javax-inject.github.io/javax-inject/ >dependency injection standard</a> (previously it was Plexus Annotations API).</p> </div> <div class=paragraph> <p>To use dependency injection with Maven we have to:</p> </div> <div class="arabic olist"> <ol class=arabic> <li> <p>Add <code>javax.inject</code> dependency to <code>pom.xml</code>, so we can use <code>@Inject</code>, <code>@Named</code>, and <code>@Singleton</code> annotations in plugin implementation Java code.</p> <div class=listingblock> <div class=title>pom.xml</div> <div class=content> <pre class=highlight><code class=language-xml data-lang=xml><span class=hljs-tag>&lt;<span class=hljs-name>dependency</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>groupId</span>></span>javax.inject<span class=hljs-tag>&lt;/<span class=hljs-name>groupId</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>artifactId</span>></span>javax.inject<span class=hljs-tag>&lt;/<span class=hljs-name>artifactId</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>version</span>></span>1<span class=hljs-tag>&lt;/<span class=hljs-name>version</span>></span>
<span class=hljs-tag>&lt;/<span class=hljs-name>dependency</span>></span></code></pre> </div> </div> </li> <li> <p>Set up the <code>sisu-maven-plugin</code> to index the <a href=https://maven.apache.org/maven-jsr330.html rel=noopener target=_blank>JSR-330</a> components you want made available to Maven.</p> <div class=listingblock> <div class=title>pom.xml</div> <div class=content> <pre class=highlight><code class=language-xml data-lang=xml><span class=hljs-tag>&lt;<span class=hljs-name>plugin</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>groupId</span>></span>org.eclipse.sisu<span class=hljs-tag>&lt;/<span class=hljs-name>groupId</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>artifactId</span>></span>sisu-maven-plugin<span class=hljs-tag>&lt;/<span class=hljs-name>artifactId</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>version</span>></span>0.3.3<span class=hljs-tag>&lt;/<span class=hljs-name>version</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>executions</span>></span>
        <span class=hljs-tag>&lt;<span class=hljs-name>execution</span>></span>
            <span class=hljs-tag>&lt;<span class=hljs-name>id</span>></span>generate-index<span class=hljs-tag>&lt;/<span class=hljs-name>id</span>></span>
            <span class=hljs-tag>&lt;<span class=hljs-name>goals</span>></span>
                <span class=hljs-tag>&lt;<span class=hljs-name>goal</span>></span>main-index<span class=hljs-tag>&lt;/<span class=hljs-name>goal</span>></span>
            <span class=hljs-tag>&lt;/<span class=hljs-name>goals</span>></span>
        <span class=hljs-tag>&lt;/<span class=hljs-name>execution</span>></span>
    <span class=hljs-tag>&lt;/<span class=hljs-name>executions</span>></span>
<span class=hljs-tag>&lt;/<span class=hljs-name>plugin</span>></span></code></pre> </div> </div> </li> <li> <p>Add annotations to your Mojo, e.g:</p> </li> </ol> </div> <div class=listingblock> <div class=title>BuildMojo.java</div> <div class=content> <pre class=highlight><code class=language-java data-lang=java><span class=hljs-meta>@Mojo</span>(name = <span class=hljs-string>"build"</span>, defaultPhase = LifecyclePhase.COMPILE) <b class=conum>(1)</b>
<span class=hljs-keyword>public</span> <span class=hljs-class><span class=hljs-keyword>class</span> <span class=hljs-title>BuildMojo</span> <span class=hljs-keyword>extends</span> <span class=hljs-title>AbstractMojo</span> </span>{

    <span class=hljs-keyword>private</span> <span class=hljs-keyword>final</span> FileSetManager fileSetManager;
    <span class=hljs-keyword>private</span> <span class=hljs-keyword>final</span> MdToHtml mdToHtml;


    <span class=hljs-meta>@Inject</span> <b class=conum>(2)</b>
    <span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-title>BuildMojo</span><span class=hljs-params>(FileSetManager fileSetManager, MdToHtml mdToHtml)</span> </span>{
        <span class=hljs-keyword>this</span>.fileSetManager = fileSetManager;
        <span class=hljs-keyword>this</span>.mdToHtml = mdToHtml;</code></pre> </div> </div> <div class="arabic colist"> <ol> <li> <p>This annotation is not a dependency injection one, we will explain later what it is for.</p> </li> <li> <p>It will inject an instance of FileSetManager and MdToHtml.</p> </li> </ol> </div> </div> <div class=sect2> <h3 id=_write_a_custom_mojo>Write a custom <a href=https://maven.apache.org/plugin-developers/index.html rel=noopener target=_blank>Mojo</a></h3> <div class=paragraph> <p>It is quite straightforward to implement a <a href=https://maven.apache.org/plugin-developers/index.html rel=noopener target=_blank>Mojo</a> class, we have to:</p> </div> <div class=sect3> <h4 id=_1_implement_mojo_interface>1. Implement Mojo interface</h4> <div class=paragraph> <p>Your <a href=https://maven.apache.org/plugin-developers/index.html rel=noopener target=_blank>Mojo</a> class has to implement <code>org.apache.maven.plugin.Mojo</code>, although it is more convenient to extend <code>org.apache.maven.plugin.AbstractMojo</code>, an abstract class to provide most of the infrastructure required to implement a Mojo except for execute method. That interface and class are described at <a href=https://maven.apache.org/developers/mojo-api-specification.html>Mojo API</a>.</p> </div> <div class=listingblock> <div class=content> <pre class=highlight><code class=language-java data-lang=java><span class=hljs-keyword>public</span> <span class=hljs-class><span class=hljs-keyword>class</span> <span class=hljs-title>BuildMojo</span> <span class=hljs-keyword>extends</span> <span class=hljs-title>AbstractMojo</span> </span>{</code></pre> </div> </div> </div> <div class=sect3> <h4 id=_2_configure_mojo_with_java_5_annotations>2. Configure Mojo with Java 5 annotations</h4> <div class=paragraph> <p>Annotate <a href=https://maven.apache.org/plugin-developers/index.html rel=noopener target=_blank>Mojo</a> class with <code>@Mojo</code> and input parameters with <code>@Parameter</code>. Those annotations belong to another set of annotations to configure Mojos, <a href=https://maven.apache.org/plugin-tools/maven-plugin-plugin/examples/using-annotations.html>Plugin Tools Java5 Annotations</a>.</p> </div> <div class=listingblock> <div class=content> <pre class=highlight><code class=language-java data-lang=java><span class=hljs-comment>/**
* Generate HTML files from Markdown files
*/</span>
<span class=hljs-meta>@Mojo</span>(name = <span class=hljs-string>"build"</span>, defaultPhase = LifecyclePhase.COMPILE) <b class=conum>(1)</b>
<span class=hljs-keyword>public</span> <span class=hljs-class><span class=hljs-keyword>class</span> <span class=hljs-title>BuildMojo</span> <span class=hljs-keyword>extends</span> <span class=hljs-title>AbstractMojo</span> </span>{

    <span class=hljs-comment>/**
    * Output directory path where HTML files are generated
    */</span>
    <span class=hljs-meta>@Parameter</span>( <b class=conum>(2)</b>
      defaultValue = <span class=hljs-string>"${project.reporting.outputDirectory}"</span>, <b class=conum>(3)</b>
      property = <span class=hljs-string>"siteOutputDirectory"</span>, <b class=conum>(4)</b>
      required = <span class=hljs-keyword>true</span>)
    <span class=hljs-keyword>private</span> File outputDirectory;

    <span class=hljs-comment>/**
    * A specific &lt;code>fileSet&lt;/code> rule to select files and directories.
    * Fileset spec: https://maven.apache.org/shared/file-management/fileset.html
    */</span>
    <span class=hljs-meta>@Parameter</span>
    <span class=hljs-keyword>private</span> FileSet inputFiles;</code></pre> </div> </div> <div class="arabic colist"> <ol> <li> <p>Configures Mojo name and default life-cycle phase. To execute the Mojo in this example we will use <code>mvn site:build</code>: <em>site</em> is the plugin name and <em>build</em> is <code>name</code> parameter.</p> </li> <li> <p>We use <code>@Parameter</code> annotation to pass configuration parameters to Mojo.</p> </li> <li> <p>You can use properties placeholder or any String. If the parameter type is not a String, then Maven will try to cast it.</p> </li> <li> <p>It allows configuration of the Mojo parameter from the command line by referencing a system property that the user sets via the -D option. E.g: <code>mvn site:build -DsiteOutputDirectory=/var/www/html</code> will set siteOutputDirectory attribute to <code>/var/www/html</code>.</p> </li> </ol> </div> <div class=paragraph> <p>HINT: More info in <a href=https://maven.apache.org/guides/plugin/guide-java-plugin-development.html#Parameters>Maven Plugin development guide in Parametera section</a>.</p> </div> </div> <div class=sect3> <h4 id=_3_implement_execute_method>3. Implement <em>execute</em> method</h4> <div class=paragraph> <p>As I have explained before at <a href=#_1_implement_mojo_interface>1. Implement Mojo interface</a>, our <a href=https://maven.apache.org/plugin-developers/index.html rel=noopener target=_blank>Mojo</a> class extends <code>org.apache.maven.plugin.AbstractMojo</code> which has one unimplemented method from <code>org.apache.maven.plugin.Mojo</code> interface. In that method we are going to implement the Maven goal logic.</p> </div> <div class=paragraph> <p><a href=https://maven.apache.org/plugin-developers/index.html rel=noopener target=_blank>Mojo</a> class instance is called from <a href=https://maven.apache.org rel=noopener target=_blank>Maven</a> execution life-cycle by invoking <code>execute()</code> method. Before calling <code>execute()</code>, <a href=https://maven.apache.org rel=noopener target=_blank>Maven</a> has performed some other tasks related with the Mojo:</p> </div> <div class="arabic olist"> <ol class=arabic> <li> <p><a href=https://maven.apache.org rel=noopener target=_blank>Maven</a> instantiates Mojo and injects dependencies (<a href=#dependency-injection>Dependency Injection</a>).</p> <div class=listingblock> <div class=content> <pre class=highlight><code class=language-java data-lang=java>Mojo mojo = <span class=hljs-keyword>new</span> BuildMojo(fileSetManager, mdToHtml);</code></pre> </div> </div> </li> <li> <p><a href=https://maven.apache.org rel=noopener target=_blank>Maven</a> configures the <a href=https://maven.apache.org/plugin-developers/index.html rel=noopener target=_blank>Mojo</a> by assigning values to parameters.</p> </li> <li> <p><a href=https://maven.apache.org rel=noopener target=_blank>Maven</a> calls execute method: <code>mojo.execute()</code>.</p> </li> </ol> </div> <div class=paragraph> <p>I will simplify <code>execute</code> method implementation in the <a href=https://github.com/carlosvin/blog-maven-plugin>sample project in github</a>, because it is more complicated and this complexity is not relevant for learning purposes.</p> </div> <div class=listingblock> <div class=title>BuildMojo.java</div> <div class=content> <pre class=highlight><code class=language-java data-lang=java><span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>void</span> <span class=hljs-title>execute</span><span class=hljs-params>()</span> <span class=hljs-keyword>throws</span> MojoExecutionException </span>{ <b class=conum>(1)</b>
    <span class=hljs-keyword>if</span> (inputFiles == <span class=hljs-keyword>null</span>) {
        setDefaultInput();
    }
    inputDirPath = Paths.get(inputFiles.getDirectory());

    String[] includedFiles = fileSetManager.getIncludedFiles(inputFiles); <b class=conum>(2)</b>

    outputDirPath = outputDirectory.toPath();
    <span class=hljs-keyword>if</span> (includedFiles == <span class=hljs-keyword>null</span> || includedFiles.length == <span class=hljs-number>0</span>) {
        getLog().warn(<span class=hljs-string>"SKIP: There are no input files. "</span> + getInputFilesToString()); <b class=conum>(3)</b>
    } <span class=hljs-keyword>else</span> {
        <span class=hljs-keyword>if</span> (!outputDirectory.exists()) { <b class=conum>(4)</b>
            outputDirectory.mkdirs();
        }
        <span class=hljs-keyword>try</span> {
            <span class=hljs-keyword>for</span> (String f : includedFiles) {
                convertToHtml(Paths.get(f), outputDirectory); <b class=conum>(5)</b>
            }
        } <span class=hljs-keyword>catch</span> (InterruptedException e) {
            <span class=hljs-keyword>throw</span> <span class=hljs-keyword>new</span> MojoExecutionException(e.getLocalizedMessage(), e); <b class=conum>(6)</b>
        }
    }
}</code></pre> </div> </div> <div class="arabic colist"> <ol> <li> <p>If there is any error during execution, it should throw MojoExecutionException.</p> </li> <li> <p>A way to get all selected files from <a href=https://maven.apache.org/shared/file-management/fileset.html>FileSet</a>.</p> </li> <li> <p>AbstractMojo supplies logger functionality.</p> </li> <li> <p>If output directory doesn’t exist, it will be created.</p> </li> <li> <p>It converts each file Markdown to HTML.</p> </li> <li> <p>Convert thrown exception to MojoExecutionException.</p> </li> </ol> </div> </div> </div> </div> </div> <div class=sect1> <h2 id=_unit_tests>Unit tests</h2> <div class=sectionbody> <div class=paragraph> <p>In the example we use <a href=https://junit.org/junit4/ >JUnit 4</a>, but you can use any other testing framework.</p> </div> <div class=paragraph> <p>Firstly, you have to add the unit test library dependency to <code>pom.xml</code>.</p> </div> <div class=listingblock> <div class=title>pom.xml</div> <div class=content> <pre class=highlight><code class=language-xml data-lang=xml><span class=hljs-tag>&lt;<span class=hljs-name>dependency</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>groupId</span>></span>junit<span class=hljs-tag>&lt;/<span class=hljs-name>groupId</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>artifactId</span>></span>junit<span class=hljs-tag>&lt;/<span class=hljs-name>artifactId</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>version</span>></span>4.11<span class=hljs-tag>&lt;/<span class=hljs-name>version</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>scope</span>></span>test<span class=hljs-tag>&lt;/<span class=hljs-name>scope</span>></span>
<span class=hljs-tag>&lt;/<span class=hljs-name>dependency</span>></span></code></pre> </div> </div> <div class=paragraph> <p>Then you just have to write your unit tests under <code>src/test/java</code> folder: <a href=https://github.com/carlosvin/blog-maven-plugin/blob/master/src/test/java/com/maven/plugins/blog/PathsTest.java>src/test/java/com/maven/plugins/blog/PathsTest.java</a>.</p> </div> <div class=paragraph> <p>To run the unit tests you just need to execute <code>mvn test</code>.</p> </div> </div> </div> <div class=sect1> <h2 id=_integration_tests>Integration tests</h2> <div class=sectionbody> <div class=paragraph> <p>The 2 most popular ways to perform integration tests on custom maven plugins are using <a href=https://maven.apache.org/surefire/maven-failsafe-plugin>maven-failsafe-plugin</a> or <a href=https://maven.apache.org/plugins/maven-invoker-plugin>maven-invoker-plugin</a>.</p> </div> <div class=paragraph> <p>I’ve chosen <a href=https://maven.apache.org/plugins/maven-invoker-plugin>maven-invoker-plugin</a> because for me it is more straightforward. There is <a href=https://stackoverflow.com/questions/40010745/maven-invoker-plugin-vs-maven-failsafe-plugin-which-to-use-for-integration-test>an answer at stackoverflow where they explain thoroughly the differences between them</a>.</p> </div> <div class=sect2> <h3 id=_how_does_invoker_plugin_work>How does Invoker Plugin work?</h3> <div class="arabic olist"> <ol class=arabic> <li> <p>We create projects to use our custom plugin under <code>src/it</code> folder, so our plugin will be applied to test projects.</p> </li> <li> <p>Invoker plugin will simulate a previously configured <a href=https://maven.apache.org rel=noopener target=_blank>Maven</a> execution.</p> </li> <li> <p>After Maven execution, A validation script will check if our plugin outputs are the expected ones. For example, if our plugin is supposed to generate a file named <code>foo.file</code>, verification plugin will check if that file exists, if it doesn’t, integration test will fail.</p> </li> </ol> </div> </div> <div class=sect2> <h3 id=_configure_invoker_plugin>Configure Invoker Plugin</h3> <div class=listingblock> <div class=content> <pre class=highlight><code class=language-xml data-lang=xml><span class=hljs-tag>&lt;<span class=hljs-name>plugin</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>artifactId</span>></span>maven-invoker-plugin<span class=hljs-tag>&lt;/<span class=hljs-name>artifactId</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>version</span>></span>3.0.1<span class=hljs-tag>&lt;/<span class=hljs-name>version</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>configuration</span>></span>
        <span class=hljs-tag>&lt;<span class=hljs-name>postBuildHookScript</span>></span>verify<span class=hljs-tag>&lt;/<span class=hljs-name>postBuildHookScript</span>></span> <b class=conum>(3)</b>
        <span class=hljs-tag>&lt;<span class=hljs-name>showVersion</span>></span>true<span class=hljs-tag>&lt;/<span class=hljs-name>showVersion</span>></span>
        <span class=hljs-tag>&lt;<span class=hljs-name>streamLogs</span>></span>true<span class=hljs-tag>&lt;/<span class=hljs-name>streamLogs</span>></span>
        <span class=hljs-tag>&lt;<span class=hljs-name>noLog</span>></span>false<span class=hljs-tag>&lt;/<span class=hljs-name>noLog</span>></span>
        <span class=hljs-tag>&lt;<span class=hljs-name>showErrors</span>></span>true<span class=hljs-tag>&lt;/<span class=hljs-name>showErrors</span>></span>
    <span class=hljs-tag>&lt;/<span class=hljs-name>configuration</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>executions</span>></span>
        <span class=hljs-tag>&lt;<span class=hljs-name>execution</span>></span>
            <span class=hljs-tag>&lt;<span class=hljs-name>id</span>></span>integration-test<span class=hljs-tag>&lt;/<span class=hljs-name>id</span>></span>
            <span class=hljs-tag>&lt;<span class=hljs-name>goals</span>></span>
                <span class=hljs-tag>&lt;<span class=hljs-name>goal</span>></span>install<span class=hljs-tag>&lt;/<span class=hljs-name>goal</span>></span> <b class=conum>(1)</b>
                <span class=hljs-tag>&lt;<span class=hljs-name>goal</span>></span>run<span class=hljs-tag>&lt;/<span class=hljs-name>goal</span>></span> <b class=conum>(2)</b>
            <span class=hljs-tag>&lt;/<span class=hljs-name>goals</span>></span>
        <span class=hljs-tag>&lt;/<span class=hljs-name>execution</span>></span>
    <span class=hljs-tag>&lt;/<span class=hljs-name>executions</span>></span>
<span class=hljs-tag>&lt;/<span class=hljs-name>plugin</span>></span></code></pre> </div> </div> <div class="arabic colist"> <ol> <li> <p><code>invoker:install</code> will be executed during the phase pre-integration-test and will install the main project artifact into target/local-repo.</p> </li> <li> <p><code>invoker:run</code> will be executed during the integration-test phase and it will execute all defined integration tests under <code>src/it</code> folder.</p> </li> <li> <p>It configures invoker plugin to execute validation script after integration test project execution. This script may be written with either BeanShell or Groovy (verify.groovy or verify.bsh).</p> </li> </ol> </div> <div class=paragraph> <p>We have used other properties to show errors, show maven log and save it to a file.</p> </div> <div class=paragraph> <p>You can check all <code>invoker:run</code> configuration properties at <a href=https://maven.apache.org/plugins/maven-invoker-plugin/run-mojo.html class=bare>https://maven.apache.org/plugins/maven-invoker-plugin/run-mojo.html</a>.</p> </div> </div> <div class=sect2> <h3 id=_create_an_integration_test_project>Create an Integration Test Project</h3> <div class=paragraph> <p>It is a project we use to execute custom plugin goals, so we can validate if it produces the expected output.</p> </div> <div class=paragraph> <p>There are 3 important files matching with <a href=http://wiki.c2.com/?ArrangeActAssert rel=noopener target=_blank>AAA</a> phases ("Arrange-Act-Assert").</p> </div> <div class=sect3> <h4 id=_arrange_pom_xml>Arrange: pom.xml</h4> <div class=paragraph> <p>This file is a project using our custom plugin.</p> </div> <div class=paragraph> <p><a href=https://github.com/carlosvin/blog-maven-plugin/blob/master/src/it/md-html/pom.xml>src/it/md-html/pom.xml</a></p> </div> <div class=listingblock> <div class=content> <pre class=highlight><code class=language-xml data-lang=xml><span class=hljs-meta>&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class=hljs-tag>&lt;<span class=hljs-name>project</span> <span class=hljs-attr>xmlns</span>=<span class=hljs-string>"http://maven.apache.org/POM/4.0.0"</span> <span class=hljs-attr>xmlns:xsi</span>=<span class=hljs-string>"http://www.w3.org/2001/XMLSchema-instance"</span>
<span class=hljs-attr>xsi:schemaLocation</span>=<span class=hljs-string>"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>modelVersion</span>></span>4.0.0<span class=hljs-tag>&lt;/<span class=hljs-name>modelVersion</span>></span>

    <span class=hljs-tag>&lt;<span class=hljs-name>groupId</span>></span>com.maven.plugins.it<span class=hljs-tag>&lt;/<span class=hljs-name>groupId</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>artifactId</span>></span>simple-it<span class=hljs-tag>&lt;/<span class=hljs-name>artifactId</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>version</span>></span>1.0-SNAPSHOT<span class=hljs-tag>&lt;/<span class=hljs-name>version</span>></span>

    <span class=hljs-tag>&lt;<span class=hljs-name>build</span>></span>
        <span class=hljs-tag>&lt;<span class=hljs-name>plugins</span>></span>
            <span class=hljs-tag>&lt;<span class=hljs-name>plugin</span>></span>
                <span class=hljs-tag>&lt;<span class=hljs-name>groupId</span>></span>@project.groupId@<span class=hljs-tag>&lt;/<span class=hljs-name>groupId</span>></span>
                <span class=hljs-tag>&lt;<span class=hljs-name>artifactId</span>></span>@project.artifactId@<span class=hljs-tag>&lt;/<span class=hljs-name>artifactId</span>></span>
                <span class=hljs-tag>&lt;<span class=hljs-name>version</span>></span>@project.version@<span class=hljs-tag>&lt;/<span class=hljs-name>version</span>></span>
            <span class=hljs-tag>&lt;/<span class=hljs-name>plugin</span>></span>
        <span class=hljs-tag>&lt;/<span class=hljs-name>plugins</span>></span>
    <span class=hljs-tag>&lt;/<span class=hljs-name>build</span>></span>
<span class=hljs-tag>&lt;/<span class=hljs-name>project</span>></span></code></pre> </div> </div> <div class=paragraph> <p>It is a very simple pom file where we use placeholders to reference to our plugin under test. When invoker plugin executes following pom file, firstly will replace those placeholders to reference to the latest version sof our custom plugin which was recently installed in the local repository:</p> </div> <div class=listingblock> <div class=content> <pre class=highlight><code class=language-xml data-lang=xml><span class=hljs-tag>&lt;<span class=hljs-name>plugin</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>groupId</span>></span>com.maven.plugins<span class=hljs-tag>&lt;/<span class=hljs-name>groupId</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>artifactId</span>></span>blog<span class=hljs-tag>&lt;/<span class=hljs-name>artifactId</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>version</span>></span>0.0.1-SNAPSHOT<span class=hljs-tag>&lt;/<span class=hljs-name>version</span>></span>
<span class=hljs-tag>&lt;/<span class=hljs-name>plugin</span>></span></code></pre> </div> </div> <div class=paragraph> <p>In that way invoker plugin ensures it is testing the latest version of current project.</p> </div> </div> <div class=sect3> <h4 id=_act_invoker_properties>Act: invoker.properties</h4> <div class=paragraph> <p>It configures how test project will be executed.</p> </div> <div class=listingblock> <div class=title><a href=https://github.com/carlosvin/blog-maven-plugin/blob/master/src/it/md-html/invoker.properties>src/it/md-html/invoker.properties</a></div> <div class=content> <pre class=highlight><code class=language-properties data-lang=properties><span class=hljs-meta>invoker.goals</span> = <span class=hljs-string>blog:build</span>
<span class=hljs-meta>invoker.name</span> = <span class=hljs-string>Test build MD</span></code></pre> </div> </div> <div class=paragraph> <p>It will execute <code>mvn blog:build</code>, a goal defined in our custom plugin under example or what is the same, it will execute <a href=https://github.com/carlosvin/blog-maven-plugin/blob/master/src/main/java/com/maven/plugins/blog/BuildMojo.java rel=noopener target=_blank>Build Mojo</a> described in section <a href=#_write_a_custom_mojo>Write a custom <a href=https://maven.apache.org/plugin-developers/index.html rel=noopener target=_blank>Mojo</a></a>.</p> </div> </div> <div class=sect3> <h4 id=_assert_verify_groovy>Assert: verify.groovy</h4> <div class=paragraph> <p>It is the script to check that plugin execution generated the expected results.</p> </div> <div class=paragraph> <p>Verification script, it is checking if <code>target/site/README.html</code> file was generated by the plugin.</p> </div> <div class=listingblock> <div class=title><a href=https://github.com/carlosvin/blog-maven-plugin/blob/master/src/it/md-html/verify.groovy>src/it/md-html/verify.groovy</a></div> <div class=content> <pre class=highlight><code class=language-groovy data-lang=groovy>File generated = <span class=hljs-keyword>new</span> File( basedir, <span class=hljs-string>"target/site/README.html"</span> );

<span class=hljs-keyword>assert</span> generated.isFile()</code></pre> </div> </div> </div> </div> </div> </div></div></main></div> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');var s=document.createElement("script");try{new Function("if(0)import('')")();s.src="/client/client.80af3338.js";s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@1.0.1.js";s.setAttribute("data-main","/client/client.80af3338.js")}document.head.appendChild(s)</script> <script async defer> (function (i, s, o, g, r, a, m) {
		i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
			(i[r].q = i[r].q || []).push(arguments)
		}, i[r].l = 1 * new Date(); a = s.createElement(o),
			m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
		})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

		ga('create', 'UA-1328360-10', 'auto');
		ga('send', 'pageview'); </script> 