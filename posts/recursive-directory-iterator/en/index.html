<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <meta content=sapper name=generator> <meta content=a22af7614c96254d name=yandex-verification> <link href=/icons/icon-192x192.png rel=apple-touch-icon> <base href=/ > <link href=global.css rel=stylesheet> <link href=manifest.json rel=manifest crossorigin=use-credentials> <link href=favicon.png rel=icon type=image/png> <link href=client/main.3755541285.css rel=stylesheet> <noscript id=sapper-head-start></noscript><title>Filesystem in C++17</title><link href=/rss rel=alternate type=application/rss+xml title="Subscribe to Carlos says bla bla"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"Webpage","@id":"https://google.com/article"},"headline":"Filesystem in C++17","alternativeHeadline":"We are going to analyze with examples new filesystem features coming with C++17","description":"We are going to analyze with examples new filesystem features coming with C++17","image":"icons/icon-192x192.png","datePublished":"2017-05-28 09:00","dateModified":"2017-05-28 09:00","keywords":["C++","C++11","C++17","IO","Filesystem"],"author":{"@type":"Person","name":"Carlos Martin Sanchez"},"publisher":"Carlos Martin Sanchez"}</script><meta content=2017-05-28 name=date scheme=YYYY-MM-DD><meta content="We are going to analyze with examples new filesystem features coming with C++17" name=description><link href=/posts/recursive-directory-iterator/es rel=alternate hreflang=es><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css rel=preload as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css rel=stylesheet></noscript><noscript id=sapper-head-end></noscript> </head> <body> <div id=sapper> <nav class=svelte-1hjvhrx><ul class=svelte-1hjvhrx><li class=svelte-1y8uoef><a href=/ class=svelte-1y8uoef><img alt="Carlos says bla bla logo" class="svelte-1hjvhrx logo" src=/favicon.png></a></ul> <ul class="svelte-1hjvhrx closed"><li class=svelte-1y8uoef><a href=/ class=svelte-1y8uoef><span class="svelte-1hjvhrx siteName">Carlos says bla bla</span></a></li> <li class=svelte-1y8uoef><a href=/categories class=svelte-1y8uoef>Categories</a></li> <li class=svelte-1y8uoef><a href=/about class=svelte-1y8uoef>About</a></ul> <div class="h svelte-1w8skyw"><a href=/rss rel=noopener target=_blank class="icon svelte-1lu397 rss" title="Subscribe to Carlos says bla bla"></a> <a href=https://github.com/carlosvin rel=noopener target=_blank class="icon svelte-1lu397 github" title="Find me at github"></a> <a href=https://twitter.com/carlosvin rel=noopener target=_blank class="icon svelte-1lu397 twitter" title="Find me at twitter"></a> <a href=https://stackoverflow.com/story/carlosvin rel=noopener target=_blank class="icon svelte-1lu397 stackoverflow" title="Find me at stackoverflow"></a></div> <button class=svelte-1hjvhrx>≡</button></nav> <main class=svelte-bvcji9> <header class=svelte-5fppzy><h1 class=svelte-5fppzy>Filesystem in C++17 <span class="svelte-5fppzy share"><a href="https://twitter.com/intent/tweet?url=https://carlosvin.github.io/posts/recursive-directory-iterator/en&text=Filesystem in C++17: We are going to analyze with examples new filesystem features coming with C++17&hashtags=C++,C++11,C++17,IO,Filesystem" rel=noopener target=_blank class="icon svelte-1lu397 twitter" title='Share "Filesystem in C++17"'></a></span></h1> <p class="svelte-5fppzy summary">We are going to analyze with examples new filesystem features coming with C++17</p> <div class="subtitle svelte-16mbbpz"><span class=date>28/05/2017</span> <span class="summary langs">Available in <span class="lang svelte-k3ijyt"><a href=/posts/recursive-directory-iterator/es rel=alternate hreflang=es>es</a> </span></span> <span class="svelte-9pgfi9 tags"><a href=/categories/c class=svelte-1ci4az4 title=C++><span class="hover svelte-4jhu6r">C++</span></a><a href=/categories/c11 class=svelte-1ci4az4 title=C++11><span class="hover svelte-4jhu6r">C++11</span></a><a href=/categories/c17 class=svelte-1ci4az4 title=C++17><span class="hover svelte-4jhu6r">C++17</span></a><a href=/categories/io class=svelte-1ci4az4 title=IO><span class="hover svelte-4jhu6r">IO</span></a><a href=/categories/filesystem class=svelte-1ci4az4 title=Filesystem><span class="hover svelte-4jhu6r">Filesystem</span></a></span></div></header> <div class="content svelte-16nh35n"><div class=toc id=toc> <div id=toctitle>Table of Contents</div> <ul class=sectlevel1> <li><a href=#_introduction>Introduction</a></li> <li><a href=#_gettting_started_with_experimental_filesystem_features_c17_g>Gettting started with Experimental Filesystem Features C++17 (g++)</a></li> <li><a href=#_c17_filesystem_features>C++17 Filesystem Features</a> <ul class=sectlevel2> <li><a href=#_stdfilesystempath>std::filesystem::path</a></li> <li><a href=#_directory_separator>Directory separator</a></li> <li><a href=#_directory_separator_operator>Directory Separator Operator</a></li> <li><a href=#_createremove_directories>Create/Remove Directories</a></li> </ul> </li> <li><a href=#_full_example_recursive_directory_iterator>Full example: Recursive Directory Iterator</a> <ul class=sectlevel2> <li><a href=#_c11>C++11</a></li> <li><a href=#_c17>C++17</a></li> </ul> </li> </ul> </div> <div class=sect1> <h2 id=_introduction>Introduction</h2> <div class=sectionbody> <div class=paragraph> <p>Since C++17 new filesystem abstractions will be added to C++ environment. So far they are available as <a href=https://en.cppreference.com/w/cpp/experimental>Experimental C++ Features</a>. If you want to dig more about this new library, here it is the <a href=http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4100.pdf rel=noopener target=_blank>final draft of File System Technical Specification</a>.</p> </div> </div> </div> <div class=sect1> <h2 id=_gettting_started_with_experimental_filesystem_features_c17_g>Gettting started with Experimental Filesystem Features C++17 (g++)</h2> <div class=sectionbody> <div class=paragraph> <p>We just have to "tell" compiler that:</p> </div> <div class=ulist> <ul> <li> <p>we write C++17 (<code>-c++1z</code>) and</p> </li> <li> <p>it has to add <em>standard library with filesystem library</em> (<code>-lstdc++fs</code>).</p> </li> </ul> </div> <div class=listingblock> <div class=content> <pre class=highlight><code class=language-bash data-lang=bash>g++ -std=c++1z main.cpp -lstdc++fs && ./a.out</code></pre> </div> </div> <div class=paragraph> <p>Let’s see a simple example with <code>std::filesystem::path</code> class.</p> </div> <div class=listingblock> <div class=content> <pre class=highlight><code class=language-cpp data-lang=cpp><span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;experimental/filesystem></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;iostream></span></span>

<span class=hljs-keyword>namespace</span> fs = <span class=hljs-built_in>std</span>::experimental::filesystem;
<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>;

<span class=hljs-function><span class=hljs-keyword>int</span> <span class=hljs-title>main</span><span class=hljs-params>()</span>
</span>{
    fs::path aPath {<span class=hljs-string>"./path/to/file.txt"</span>};

    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"Parent path: "</span> &lt;&lt; aPath.parent_path() &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"Filename: "</span> &lt;&lt; aPath.filename() &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"Extension: "</span> &lt;&lt; aPath.extension() &lt;&lt; <span class=hljs-built_in>endl</span>;

    <span class=hljs-keyword>return</span> <span class=hljs-number>0</span>;
}</code></pre> </div> </div> <div class=listingblock> <div class=title><a href=https://coliru.stacked-crooked.com/a/9f8bebb8b7f0fbe7 rel=noopener target=_blank>Compile and run: Basic C++17 example</a></div> <div class=content> <pre class=highlight><code class=language-bash data-lang=bash>$ g++ -std=c++1z main.cpp -lstdc++fs && ./a.out
$ ./a.out

Parent path: <span class=hljs-string>"./path/to"</span>
Filename: <span class=hljs-string>"file.txt"</span>
Extension: <span class=hljs-string>".txt"</span></code></pre> </div> </div> </div> </div> <div class=sect1> <h2 id=_c17_filesystem_features>C++17 Filesystem Features</h2> <div class=sectionbody> <div class=paragraph> <p>In this section, we are going to explain some <a href=https://en.cppreference.com/w/cpp/filesystem rel=noopener target=_blank>std::filesystem</a> features with examples, which will help us to highlight differences between C++11 and C++17 so we can get a better idea about what this new library will supply and how it might make developer’s work easier.</p> </div> <div class=sect2> <h3 id=_stdfilesystempath>std::filesystem::path</h3> <div class=paragraph> <p>Upper we have seen a tiny <a href=https://coliru.stacked-crooked.com/a/9f8bebb8b7f0fbe7 rel=noopener target=_blank>use case for std::filesystem::path</a>. That is a quite powerful and convenient feature that supplies an multi-platform abstraction for paths to files using the correct directory path separator depending on the platform we are building our application for (<code>\</code> for Windows based systems and <code>/</code> for Unix based systems).</p> </div> </div> <div class=sect2> <h3 id=_directory_separator>Directory separator</h3> <div class=paragraph> <p>When we want our application to use the correct directory separator in C++11, we could use conditional macro declaration:</p> </div> <div class=listingblock> <div class=title>Platform independent directory separator in C++11</div> <div class=content> <pre class=highlight><code class=language-cpp data-lang=cpp><span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;iostream></span></span>

<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>;

<span class=hljs-meta>#<span class=hljs-meta-keyword>ifdef</span> _WIN32</span>
<span class=hljs-keyword>const</span> <span class=hljs-built_in>string</span> SEP = <span class=hljs-string>"\\"</span>;
<span class=hljs-meta>#<span class=hljs-meta-keyword>else</span></span>
<span class=hljs-keyword>const</span> <span class=hljs-built_in>string</span> SEP = <span class=hljs-string>"/"</span>;
<span class=hljs-meta>#<span class=hljs-meta-keyword>endif</span></span>

<span class=hljs-function><span class=hljs-keyword>int</span> <span class=hljs-title>main</span><span class=hljs-params>()</span>
</span>{
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"Separator in my system "</span> &lt;&lt; SEP &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-keyword>return</span> <span class=hljs-number>0</span>;
}</code></pre> </div> </div> <div class=paragraph> <p><a href=https://coliru.stacked-crooked.com/a/5023ee989105fc54 rel=noopener target=_blank>Compile and run: C++11 separator example</a>.</p> </div> <div class=listingblock> <div class=title>Platform independent directory separator in C++17. Cleaner and simpler.</div> <div class=content> <pre class=highlight><code class=language-cpp data-lang=cpp><span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;experimental/filesystem></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;iostream></span></span>

<span class=hljs-keyword>namespace</span> fs = <span class=hljs-built_in>std</span>::experimental::filesystem;
<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>;

<span class=hljs-function><span class=hljs-keyword>int</span> <span class=hljs-title>main</span><span class=hljs-params>()</span>
</span>{
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"Separator in my system "</span> &lt;&lt; fs::path::preferred_separator &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-keyword>return</span> <span class=hljs-number>0</span>;
}</code></pre> </div> </div> <div class=paragraph> <p><a href=https://coliru.stacked-crooked.com/a/1f2f63b3f5597d05 rel=noopener target=_blank>Compile and run: C++17 separator example</a>.</p> </div> </div> <div class=sect2> <h3 id=_directory_separator_operator>Directory Separator Operator</h3> <div class=paragraph> <p><a href=https://en.cppreference.com/w/cpp/filesystem/path>std::filesystem::path</a> implements <code>/</code> operator, which allows to easily concatenate paths to files and directories.</p> </div> <div class=paragraph> <p>When we want to concatenate paths in C++11, we have to add extra logic to avoid adding duplicate separators and to select the correct separator for target platform:</p> </div> <div class=listingblock> <div class=title>Concatenate paths in C++11</div> <div class=content> <pre class=highlight><code class=language-cpp data-lang=cpp><span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;iostream></span></span>

<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>;

<span class=hljs-meta>#<span class=hljs-meta-keyword>ifdef</span> _WIN32</span>
<span class=hljs-keyword>const</span> <span class=hljs-built_in>string</span> SEP = <span class=hljs-string>"\\"</span>;
<span class=hljs-meta>#<span class=hljs-meta-keyword>else</span></span>
<span class=hljs-keyword>const</span> <span class=hljs-built_in>string</span> SEP = <span class=hljs-string>"/"</span>;
<span class=hljs-meta>#<span class=hljs-meta-keyword>endif</span></span>

<span class=hljs-function><span class=hljs-keyword>int</span> <span class=hljs-title>main</span><span class=hljs-params>()</span>
</span>{
    <span class=hljs-built_in>string</span> root {<span class=hljs-string>"/"</span>};
    <span class=hljs-built_in>string</span> dir {<span class=hljs-string>"var/www/"</span>};
    <span class=hljs-built_in>string</span> index {<span class=hljs-string>"index.html"</span>};

    <span class=hljs-built_in>string</span> pathToIndex{};
    pathToIndex.append(root).append(SEP).append(dir).append(SEP).append(index);

    <span class=hljs-built_in>cout</span> &lt;&lt; pathToIndex &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-keyword>return</span> <span class=hljs-number>0</span>;
}</code></pre> </div> </div> <div class=listingblock> <div class=title><a href=https://coliru.stacked-crooked.com/a/290b278ec1de9573 rel=noopener target=_blank>Compile and run: Concatenate paths in C++11</a></div> <div class=content> <pre class=highlight><code class=language-bash data-lang=bash>//var/www//index.html</code></pre> </div> </div> <div class=paragraph> <p>Checking program output we notice it is not fully correct, we should have checked whether path parts already contains a separator so we don’t append another separator again. That logic is already implemented in <a href=https://en.cppreference.com/w/cpp/filesystem/path>std::filesystem::path</a>, so C++17 can be like:</p> </div> <div class=listingblock> <div class=title>Concatenate paths in C++17</div> <div class=content> <pre class=highlight><code class=language-cpp data-lang=cpp><span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;experimental/filesystem></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;iostream></span></span>

<span class=hljs-keyword>namespace</span> fs = <span class=hljs-built_in>std</span>::experimental::filesystem;
<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>;

<span class=hljs-function><span class=hljs-keyword>int</span> <span class=hljs-title>main</span><span class=hljs-params>()</span>
</span>{
    fs::path root {<span class=hljs-string>"/"</span>};
    fs::path dir {<span class=hljs-string>"var/www/"</span>};
    fs::path index {<span class=hljs-string>"index.html"</span>};

    fs::path pathToIndex = root / dir / index;

    <span class=hljs-built_in>cout</span> &lt;&lt; pathToIndex &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-keyword>return</span> <span class=hljs-number>0</span>;
}</code></pre> </div> </div> <div class=listingblock> <div class=title><a href=https://coliru.stacked-crooked.com/a/a24d50875b4daad1>Compile and run: Concatenate paths in C++17</a>.</div> <div class=content> <pre class=highlight><code class=language-bash data-lang=bash><span class=hljs-string>"/var/www/index.html"</span></code></pre> </div> </div> <div class=paragraph> <p>Code is cleaner and just correct, there are no duplicated separators.</p> </div> </div> <div class=sect2> <h3 id=_createremove_directories>Create/Remove Directories</h3> <div class=paragraph> <p><a href=https://en.cppreference.com/w/cpp/filesystem rel=noopener target=_blank>std::filesystem</a> comes with some utilities to create and remove files and directories, but firstly let’s try to do so in C++11.</p> </div> <div class=listingblock> <div class=title>Create and remove nested directories in C++11</div> <div class=content> <pre class=highlight><code class=language-cpp data-lang=cpp><span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;iostream></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;cstdio></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;sys/stat.h></span></span>

<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>;

<span class=hljs-function><span class=hljs-keyword>int</span> <span class=hljs-title>main</span><span class=hljs-params>()</span>
</span>{
    <span class=hljs-keyword>auto</span> opts = S_IRWXU | S_IRWXG | S_IROTH | S_IXOTH;
    mkdir(<span class=hljs-string>"sandbox"</span>, opts);
    mkdir(<span class=hljs-string>"sandbox/a"</span>, opts);
    mkdir(<span class=hljs-string>"sandbox/a/b"</span>, opts);
    mkdir(<span class=hljs-string>"sandbox/c"</span>, opts);
    mkdir(<span class=hljs-string>"sandbox/c/d"</span>, opts);

    system(<span class=hljs-string>"ls -la sandbox/*"</span>);

    remove(<span class=hljs-string>"sandbox/c/d"</span>);
    remove(<span class=hljs-string>"sandbox/a/b"</span>);
    remove(<span class=hljs-string>"sandbox/c"</span>);
    remove(<span class=hljs-string>"sandbox/a"</span>);
    remove(<span class=hljs-string>"sandbox"</span>);

    system(<span class=hljs-string>"ls -la"</span>);

    <span class=hljs-keyword>return</span> <span class=hljs-number>0</span>;
}</code></pre> </div> </div> <div class=listingblock> <div class=title><a href=https://coliru.stacked-crooked.com/a/26f4763ec5b42adb>Compile and run: Create and remove directories C++11</a>.</div> <div class=content> <pre class=highlight><code class=language-bash data-lang=bash>g++-4.9 -std=c++11 main.cpp -lm && ./a.out
sandbox/a:
total 12
drwxr-xr-x 3 2001 2000 4096 May 28 12:27 .
drwxr-xr-x 4 2001 2000 4096 May 28 12:27 ..
drwxr-xr-x 2 2001 2000 4096 May 28 12:27 b

sandbox/c:
total 12
drwxr-xr-x 3 2001 2000 4096 May 28 12:27 .
drwxr-xr-x 4 2001 2000 4096 May 28 12:27 ..
drwxr-xr-x 2 2001 2000 4096 May 28 12:27 d
total 8012
drwxrwxrwx 2 2001 2000    4096 May 28 12:27 .
drwxrwxrwx 3 2002 2000 8175616 May 28 12:27 ..
-rwxr-xr-x 1 2001 2000    8168 May 28 12:27 a.out
-rw-rw-rw- 1 2001 2000     517 May 28 12:27 main.cpp</code></pre> </div> </div> <div class=paragraph> <p>We have to create/remove one by one. We could rewrite this code snippet with less lines (using a loop), but we still have to pay attention to creation/deletion order, we cannot remove parent directory before we have removed all children.</p> </div> <div class=paragraph> <p>Since C++17, we can create and remove nested directories with just one call.</p> </div> <div class=listingblock> <div class=title>Create and remove nested directories C++17</div> <div class=content> <pre class=highlight><code class=language-cpp data-lang=cpp><span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;experimental/filesystem></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;iostream></span></span>

<span class=hljs-keyword>namespace</span> fs = <span class=hljs-built_in>std</span>::experimental::filesystem;
<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>;

<span class=hljs-function><span class=hljs-keyword>int</span> <span class=hljs-title>main</span><span class=hljs-params>()</span>
</span>{
    fs::create_directories(<span class=hljs-string>"sandbox/a/b"</span>);
    fs::create_directories(<span class=hljs-string>"sandbox/c/d"</span>);
    system(<span class=hljs-string>"ls -la sandbox/*"</span>);

    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"Were directories removed? "</span> &lt;&lt; fs::remove_all(<span class=hljs-string>"sandbox"</span>) &lt;&lt; <span class=hljs-built_in>endl</span>;
    system(<span class=hljs-string>"ls -la"</span>);

    <span class=hljs-keyword>return</span> <span class=hljs-number>0</span>;
}</code></pre> </div> </div> <div class=listingblock> <div class=title><a href=https://coliru.stacked-crooked.com/a/62c2d22fa0e7144c>Compile and run: Create and remove nested directories C++17</a>.</div> <div class=content> <pre class=highlight><code class=language-bash data-lang=bash>g++ -std=c++1z -fconcepts -fgnu-tm  -O2 -Wall -Wextra -pedantic -pthread -pedantic-errors main.cpp -lm  -latomic -lstdc++fs && ./a.out
sandbox/a:
total 12
drwxr-xr-x 3 2001 2000 4096 May 28 16:45 .
drwxr-xr-x 4 2001 2000 4096 May 28 16:45 ..
drwxr-xr-x 2 2001 2000 4096 May 28 16:45 b

sandbox/c:
total 12
drwxr-xr-x 3 2001 2000 4096 May 28 16:45 .
drwxr-xr-x 4 2001 2000 4096 May 28 16:45 ..
drwxr-xr-x 2 2001 2000 4096 May 28 16:45 d
Were directories removed? 1
total 10132
drwxrwxrwx 2 2001 2000    4096 May 28 16:45 .
drwxrwxrwx 3 2002 2000 8175616 May 28 16:45 ..
-rwxr-xr-x 1 2001 2000 2170976 May 28 16:45 a.out
-rw-rw-rw- 1 2001 2000     393 May 28 16:45 main.cpp</code></pre> </div> </div> </div> </div> </div> <div class=sect1> <h2 id=_full_example_recursive_directory_iterator>Full example: Recursive Directory Iterator</h2> <div class=sectionbody> <div class=paragraph> <p>This example consists of iterate recursively through dicrectories fintering files by extension.</p> </div> <div class=sect2> <h3 id=_c11>C++11</h3> <div class=paragraph> <p>To keep C++11 example simple, I haven’t added filtering logic, but filtering logic is present in C++17 example:</p> </div> <div class=listingblock> <div class=title>filesystem.11.cpp</div> <div class=content> <pre class=highlight><code class=language-cpp data-lang=cpp><span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;dirent.h></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;cstring></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;iostream></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;fstream> // std::ofstream</span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;vector></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;memory></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;system_error></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;sys/stat.h></span></span>

<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>;

<span class=hljs-keyword>const</span> <span class=hljs-built_in>string</span> UP_DIR = <span class=hljs-string>".."</span>;
<span class=hljs-keyword>const</span> <span class=hljs-built_in>string</span> CURRENT_DIR = <span class=hljs-string>"."</span>;
<span class=hljs-keyword>const</span> <span class=hljs-built_in>string</span> SEP = <span class=hljs-string>"/"</span>;


<span class=hljs-function><span class=hljs-built_in>string</span> <span class=hljs-title>path</span><span class=hljs-params>(<span class=hljs-built_in>initializer_list</span>&lt;<span class=hljs-built_in>string</span>> parts)</span>
</span>{
    <span class=hljs-built_in>string</span> pathTmp {};
    <span class=hljs-built_in>string</span> separator = <span class=hljs-string>""</span>;
    <span class=hljs-keyword>for</span> (<span class=hljs-keyword>auto</span> & part: parts)
    {
        pathTmp.append(separator).append(part);
        separator = SEP;
    }
    <span class=hljs-keyword>return</span> pathTmp;
}

<span class=hljs-function><span class=hljs-built_in>vector</span>&lt;<span class=hljs-built_in>string</span>> <span class=hljs-title>getDirectoryFiles</span><span class=hljs-params>(<span class=hljs-keyword>const</span> <span class=hljs-built_in>string</span>& dir, <span class=hljs-keyword>const</span> <span class=hljs-built_in>vector</span>&lt;<span class=hljs-built_in>string</span>> & extensions)</span>
</span>{
    <span class=hljs-built_in>vector</span>&lt;<span class=hljs-built_in>string</span>> files;
    <span class=hljs-function><span class=hljs-built_in>shared_ptr</span>&lt;DIR> <span class=hljs-title>directory_ptr</span><span class=hljs-params>(opendir(dir.c_str()), [](DIR* dir){ dir && closedir(dir); })</span></span>;
    <span class=hljs-keyword>if</span> (!directory_ptr)
    {
        <span class=hljs-keyword>throw</span> system_error(error_code(errno, system_category()), <span class=hljs-string>"Error opening : "</span> + dir);
    }

    <span class=hljs-class><span class=hljs-keyword>struct</span> <span class=hljs-title>dirent</span> *<span class=hljs-title>dirent_ptr</span>;</span>
    <span class=hljs-keyword>while</span> ((dirent_ptr = readdir(directory_ptr.get())) != <span class=hljs-literal>nullptr</span>)
    {
        <span class=hljs-keyword>const</span> <span class=hljs-built_in>string</span> fileName {dirent_ptr->d_name};
        <span class=hljs-keyword>if</span> (dirent_ptr->d_type == DT_DIR)
        {
            <span class=hljs-keyword>if</span> (CURRENT_DIR != fileName && UP_DIR != fileName)
            {
                <span class=hljs-keyword>auto</span> subFiles = getDirectoryFiles(path({dir, fileName}), extensions);
                files.insert(end(files), begin(subFiles), end(subFiles));
            }
        }
        <span class=hljs-keyword>else</span> <span class=hljs-keyword>if</span> (dirent_ptr->d_type == DT_REG)
        {
            <span class=hljs-comment>// here we should check also if filename has an extension in extensions vector</span>
            files.push_back(path({dir, fileName}));
        }
    }
    <span class=hljs-keyword>return</span> files;
}

<span class=hljs-function><span class=hljs-keyword>int</span> <span class=hljs-title>main</span> <span class=hljs-params>()</span>
</span>{
    <span class=hljs-keyword>auto</span> opt = S_IRWXU | S_IRWXG | S_IROTH | S_IXOTH;
    mkdir(<span class=hljs-string>"sandbox"</span>, opt);
    mkdir(<span class=hljs-string>"sandbox/a"</span>, opt);
    mkdir(<span class=hljs-string>"sandbox/a/b"</span>, opt);

	<span class=hljs-built_in>vector</span>&lt;<span class=hljs-built_in>string</span>> e_files = {
	    <span class=hljs-string>"./sandbox/a/b/file1.rst"</span>,
	    <span class=hljs-string>"./sandbox/a/b/file1.txt"</span>,
	    <span class=hljs-string>"./sandbox/a/file2.RST"</span>,
	    <span class=hljs-string>"./sandbox/file3.md"</span>,
	    <span class=hljs-string>"./sandbox/will_be.ignored"</span>
	};

	<span class=hljs-comment>// create files</span>
	<span class=hljs-keyword>for</span> (<span class=hljs-keyword>auto</span> &f: e_files)
	{
		<span class=hljs-function>ofstream <span class=hljs-title>of</span><span class=hljs-params>(f, ofstream::out)</span></span>;
		of &lt;&lt; <span class=hljs-string>"test"</span>;
	}

    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"filtered files: "</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
	<span class=hljs-keyword>for</span> (<span class=hljs-keyword>auto</span> &f: getDirectoryFiles(<span class=hljs-string>"."</span>, {<span class=hljs-string>".rst"</span>, <span class=hljs-string>".RST"</span>, <span class=hljs-string>".md"</span>})){
	    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"\t"</span> &lt;&lt; f &lt;&lt; <span class=hljs-built_in>endl</span>;
	}

    <span class=hljs-keyword>return</span> <span class=hljs-number>0</span>;
}</code></pre> </div> </div> <div class=listingblock> <div class=title><a href=https://coliru.stacked-crooked.com/a/af4228e039a281b3 rel=noopener target=_blank>Compile and run C++11 example</a>.</div> <div class=content> <pre class=highlight><code class=language-bash data-lang=bash>g++ -std=c++11 -O2 -Wall -Wextra -pedantic -pthread -pedantic-errors main.cpp -lm  -latomic -lstdc++fs && ./a.out
filtered files:
	./main.cpp
	./sandbox/file3.md
	./sandbox/will_be.ignored
	./sandbox/a/b/file1.rst
	./sandbox/a/b/file1.txt
	./sandbox/a/file2.RST
	./a.out</code></pre> </div> </div> </div> <div class=sect2> <h3 id=_c17>C++17</h3> <div class=paragraph> <p>Following example also filters files by extension.</p> </div> <div class=listingblock> <div class=title>filesystem.17.cpp</div> <div class=content> <pre class=highlight><code class=language-bash data-lang=bash><span class=hljs-comment>#include &lt;dirent.h></span>
<span class=hljs-comment>#include &lt;cstring></span>
<span class=hljs-comment>#include &lt;iostream></span>
<span class=hljs-comment>#include &lt;fstream> // std::ofstream</span>
<span class=hljs-comment>#include &lt;vector></span>
<span class=hljs-comment>#include &lt;memory></span>
<span class=hljs-comment>#include &lt;system_error></span>
<span class=hljs-comment>#include &lt;sys/stat.h></span>

using namespace std;

const string UP_DIR = <span class=hljs-string>".."</span>;
const string CURRENT_DIR = <span class=hljs-string>"."</span>;
const string SEP = <span class=hljs-string>"/"</span>;


string path(initializer_list&lt;string> parts)
{
    string pathTmp {};
    string separator = <span class=hljs-string>""</span>;
    <span class=hljs-keyword>for</span> (auto & part: parts)
    {
        pathTmp.append(separator).append(part);
        separator = SEP;
    }
    <span class=hljs-built_in>return</span> pathTmp;
}

vector&lt;string> getDirectoryFiles(const string& dir, const vector&lt;string> & extensions)
{
    vector&lt;string> files;
    shared_ptr&lt;DIR> directory_ptr(opendir(dir.c_str()), [](DIR* dir){ dir && closedir(dir); });
    <span class=hljs-keyword>if</span> (!directory_ptr)
    {
        throw system_error(error_code(errno, system_category()), <span class=hljs-string>"Error opening : "</span> + dir);
    }

    struct dirent *dirent_ptr;
    <span class=hljs-keyword>while</span> ((dirent_ptr = readdir(directory_ptr.get())) != nullptr)
    {
        const string fileName {dirent_ptr->d_name};
        <span class=hljs-keyword>if</span> (dirent_ptr->d_type == DT_DIR)
        {
            <span class=hljs-keyword>if</span> (CURRENT_DIR != fileName && UP_DIR != fileName)
            {
                auto subFiles = getDirectoryFiles(path({dir, fileName}), extensions);
                files.insert(end(files), begin(subFiles), end(subFiles));
            }
        }
        <span class=hljs-keyword>else</span> <span class=hljs-keyword>if</span> (dirent_ptr->d_type == DT_REG)
        {
            // here we should check also <span class=hljs-keyword>if</span> filename has an extension <span class=hljs-keyword>in</span> extensions vector
            files.push_back(path({dir, fileName}));
        }
    }
    <span class=hljs-built_in>return</span> files;
}

int <span class=hljs-function><span class=hljs-title>main</span></span> ()
{
    auto opt = S_IRWXU | S_IRWXG | S_IROTH | S_IXOTH;
    mkdir(<span class=hljs-string>"sandbox"</span>, opt);
    mkdir(<span class=hljs-string>"sandbox/a"</span>, opt);
    mkdir(<span class=hljs-string>"sandbox/a/b"</span>, opt);

	vector&lt;string> e_files = {
	    <span class=hljs-string>"./sandbox/a/b/file1.rst"</span>,
	    <span class=hljs-string>"./sandbox/a/b/file1.txt"</span>,
	    <span class=hljs-string>"./sandbox/a/file2.RST"</span>,
	    <span class=hljs-string>"./sandbox/file3.md"</span>,
	    <span class=hljs-string>"./sandbox/will_be.ignored"</span>
	};

	// create files
	<span class=hljs-keyword>for</span> (auto &f: e_files)
	{
		ofstream of(f, ofstream::out);
		of &lt;&lt; <span class=hljs-string>"test"</span>;
	}

    cout &lt;&lt; <span class=hljs-string>"filtered files: "</span> &lt;&lt; endl;
	<span class=hljs-keyword>for</span> (auto &f: getDirectoryFiles(<span class=hljs-string>"."</span>, {<span class=hljs-string>".rst"</span>, <span class=hljs-string>".RST"</span>, <span class=hljs-string>".md"</span>})){
	    cout &lt;&lt; <span class=hljs-string>"\t"</span> &lt;&lt; f &lt;&lt; endl;
	}

    <span class=hljs-built_in>return</span> 0;
}</code></pre> </div> </div> <div class=listingblock> <div class=title><a href=https://coliru.stacked-crooked.com/a/af4228e039a281b3 rel=noopener target=_blank>Compile and run C++17 example</a>.</div> <div class=content> <pre class=highlight><code class=language-bash data-lang=bash>g++ -std=c++11 -O2 -Wall -Wextra -pedantic -pthread -pedantic-errors main.cpp -lm  -latomic -lstdc++fs && ./a.out
filtered files:
	./main.cpp
	./sandbox/file3.md
	./sandbox/will_be.ignored
	./sandbox/a/b/file1.rst
	./sandbox/a/b/file1.txt
	./sandbox/a/file2.RST
	./a.out</code></pre> </div> </div> </div> </div> </div></div></main></div> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');var s=document.createElement("script");try{new Function("if(0)import('')")();s.src="/client/client.4845edae.js";s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@1.0.1.js";s.setAttribute("data-main","/client/client.4845edae.js")}document.head.appendChild(s)</script> <script async defer> (function (i, s, o, g, r, a, m) {
		i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
			(i[r].q = i[r].q || []).push(arguments)
		}, i[r].l = 1 * new Date(); a = s.createElement(o),
			m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
		})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

		ga('create', 'UA-1328360-10', 'auto');
		ga('send', 'pageview'); </script> 