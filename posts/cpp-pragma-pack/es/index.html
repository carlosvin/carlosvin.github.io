<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <meta content=sapper name=generator> <meta content=a22af7614c96254d name=yandex-verification> <link href=/icons/icon-192x192.png rel=apple-touch-icon integrity=sha384-wrGPakCw2XdE/oEQRn84jTytG8qKzGn3Eu8nUKzAHeYJ9owQpEUNewZQOj4IoHI3> <base href=/ > <link href=global.css rel=preload integrity=sha384-fiuqT5r+RVuofLff3X+ZyczUdcS2X+eYqZ9ZH11qUKkXpGM97J5Tqv94KeeeZqyo as=style> <link href=global.css rel=stylesheet integrity=sha384-fiuqT5r+RVuofLff3X+ZyczUdcS2X+eYqZ9ZH11qUKkXpGM97J5Tqv94KeeeZqyo> <link href=manifest.json rel=manifest integrity=sha384-uvbABvsfA2LgNgoldfTIad7QYRrMk+jJ53noiFxFxSEdOUxSJQBfr7R8Lud6Dyoo crossorigin=use-credentials> <link href=favicon.png rel=icon integrity=sha384-k8dlcHultdr3I+D1KxjtRCLXRS3o9oW0PMaVQGBP7STX5RLtgO2XLPbDIojwN796 type=image/png> <script> window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) }; ga.l = +new Date;
		ga('create', 'UA-1328360-10', 'auto');
		ga('send', 'pageview'); </script> <script async src=https://www.google-analytics.com/analytics.js></script> <title>Alineación de una Estructura C++ en Memoria</title><link href=/feeds/en.xml rel=alternate type=application/atom+xml title="Subscribe to Carlos says bla bla"><meta content=2012-11-26 name=date.created><meta content=2012-11-26 name=date.updated><meta content="Comprendiendo cómo funciona la directiva C++ pragma pack y cómo afecta a la alineación de la memoria" name=description><link href=/posts/cpp-pragma-pack/en rel=alternate hreflang=en><link href=/posts/cpp-pragma-pack/es.jsonld rel=alternate type=application/ld+json> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,(function(a,b){return {html:"\u003Cdiv id=\"toc\" class=\"toc\"\u003E\n\u003Cdiv id=\"toctitle\"\u003ETable of Contents\u003C\u002Fdiv\u003E\n\u003Cul class=\"sectlevel1\"\u003E\n\u003Cli\u003E\u003Ca href=\"#_estructura_de_ejemplo\"\u003EEstructura de ejemplo\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#_la_directiva_pragma_pack_en_struct_c\"\u003ELa directiva #pragma pack en struct C++\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#_rendimiento\"\u003ERendimiento\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv id=\"preamble\"\u003E\n\u003Cdiv class=\"sectionbody\"\u003E\n\u003Cdiv class=\"paragraph\"\u003E\n\u003Cp\u003EUn struct de C++ es un elemento que permite agrupar elementos de tipos distintos con alguna relación entre ellos. Esto permite manipular todos los elementos en bloque mediante una única referencia. Podemos considerarlo como una clase con visibilidad publica por defecto para sus atributos y funciones.\u003C\u002Fp\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"paragraph\"\u003E\n\u003Cp\u003ESi alguna vez nos interesa trabajar a un nivel más bajo, nos puede resultar útil entender cómo se mapea una estructura en memoria y cómo controlar este mapeo.\u003C\u002Fp\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"sect1\"\u003E\n\u003Ch2 id=\"_estructura_de_ejemplo\"\u003EEstructura de ejemplo\u003C\u002Fh2\u003E\n\u003Cdiv class=\"sectionbody\"\u003E\n\u003Cdiv class=\"paragraph\"\u003E\n\u003Cp\u003EEsta estructura estará compuesta por dos campos, un entero (4 bytes) y un booleano (un byte). En C++ queda de la siguiente forma:\u003C\u002Fp\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"listingblock\"\u003E\n\u003Cdiv class=\"content\"\u003E\n\u003Cpre tabindex=\"0\" class=\"highlight\"\u003E\u003Ccode class=\"language-c++\" data-lang=\"c++\"\u003E\u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003ESampleStruct\u003C\u002Fspan\u003E\n{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-keyword\"\u003Ebool\u003C\u002Fspan\u003E flag;\n    \u003Cspan class=\"hljs-keyword\"\u003Eunsigned\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E timeout;\n};\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"paragraph\"\u003E\n\u003Cp\u003ESi hacemos un \u003Ccode\u003Esizeof\u003C\u002Fcode\u003E de una instancia de la estructura deberíamos obtener un tamaño de 5 bytes. Y la memoria quedaría de la siguiente forma:\u003C\u002Fp\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv id=\"5-bytes\" class=\"imageblock center\"\u003E\n\u003Cdiv class=\"content\"\u003E\n\u003Cimg src=\"\u002Fimages\u002Fc-mem-struct\u002F5b.png\" alt=\"5Bytes\" width=\"200\" height=\"auto\"\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"title\"\u003EFigure 1. Estructura de 5 bytes que realmente ocupa 5 bytes en memoria\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"paragraph\"\u003E\n\u003Cp\u003E\u003Cstrong\u003EPero\u003C\u002Fstrong\u003E no es tan sencillo, a continuación veremos que no nos podemos olvidar de la alineación de la memoria que hace el compilador en ese sistema y veremos cómo controlarlo para no encontrarnos con tamaños inesperados, ya que esto depende del compilador del sistema.\u003C\u002Fp\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"paragraph\"\u003E\n\u003Cp\u003EPor ejemplo, si en mi máquina hago un \u003Ccode\u003Esizeof\u003C\u002Fcode\u003E de la estructura de ejemplo, \u003Cstrong\u003Eobtengo un tamaño de 8 bytes\u003C\u002Fstrong\u003E. Lo que está sucediendo es que el compilador reserva más memoria al final de la estructura para que cuadre en bloques de 2n Bytes. La memoria realmente queda de la siguiente forma:\u003C\u002Fp\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv id=\"8-bytes\" class=\"imageblock center\"\u003E\n\u003Cdiv class=\"content\"\u003E\n\u003Cimg src=\"\u002Fimages\u002Fc-mem-struct\u002F8b.png\" alt=\"5Bytes\" width=\"200\" height=\"auto\"\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"title\"\u003ESin pragma: Estructura de 5 Bytes que realmente ocupa 8 Bytes en memoria\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"listingblock\"\u003E\n\u003Cdiv class=\"title\"\u003EFragmento de código que imprime el tamaño de la estructura y el de cada uno de sus atributos, en este caso 4 + 1 no es 5\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"content\"\u003E\n\u003Cpre tabindex=\"0\" class=\"highlight\"\u003E\u003Ccode class=\"language-c++\" data-lang=\"c++\"\u003E\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Einclude\u003C\u002Fspan\u003E  \u003Cspan class=\"hljs-meta-string\"\u003E&lt;iostream&gt;\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"hljs-keyword\"\u003Eusing\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Enamespace\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003Estd\u003C\u002Fspan\u003E;\n\n\u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003ESampleStruct\u003C\u002Fspan\u003E\n{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-keyword\"\u003Ebool\u003C\u002Fspan\u003E flag;\n    \u003Cspan class=\"hljs-keyword\"\u003Eunsigned\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E timeout;\n};\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Eprint\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-params\"\u003E(\u003Cspan class=\"hljs-keyword\"\u003Esize_t\u003C\u002Fspan\u003E sz, \u003Cspan class=\"hljs-keyword\"\u003Esize_t\u003C\u002Fspan\u003E sz_flag, \u003Cspan class=\"hljs-keyword\"\u003Esize_t\u003C\u002Fspan\u003E sz_timeout)\u003C\u002Fspan\u003E\n\u003C\u002Fspan\u003E{\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"\\tflag: \"\u003C\u002Fspan\u003E &lt;&lt; sz_flag &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" Bytes\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"\\t+\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"\\ttimeout: \"\u003C\u002Fspan\u003E &lt;&lt; sz_timeout &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" Bytes\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"\\t=\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"\\t\"\u003C\u002Fspan\u003E &lt;&lt; sz_timeout + sz_flag &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" Bytes\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt;\u003Cspan class=\"hljs-string\"\u003E\"sizeof struct:  \"\u003C\u002Fspan\u003E &lt;&lt; sz &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" Bytes\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n}\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E(\u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E argc, \u003Cspan class=\"hljs-keyword\"\u003Echar\u003C\u002Fspan\u003E *argv[])\u003C\u002Fspan\u003E\n\u003C\u002Fspan\u003E{\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"SampleStruct\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Eprint\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStruct), \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStruct::flag), \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStruct::timeout));\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" -- \"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n\n    \u003Cspan class=\"hljs-keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E;\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"listingblock\"\u003E\n\u003Cdiv class=\"title\"\u003E\u003Ca href=\"https:\u002F\u002Fcoliru.stacked-crooked.com\u002Fa\u002Fc7deb3df49bebd40\"\u003EEjecutando el código sin la directiva pragma\u003C\u002Fa\u003E, tenemos que nuestra estructura ocupa 8 bytes en lugar de 5 bytes.\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"content\"\u003E\n\u003Cpre tabindex=\"0\" class=\"highlight\"\u003E\u003Ccode class=\"language-bash\" data-lang=\"bash\"\u003ESampleStruct\nflag: 1 Bytes\n+\ntimeout: 4 Bytes\n=\n5 Bytes\nsizeof struct:  8 Bytes\n--\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"admonitionblock tip\"\u003E\n\u003Ctable\u003E\n\u003Ctr\u003E\n\u003Ctd class=\"icon\"\u003E\n\u003Cdiv class=\"title\"\u003ETip\u003C\u002Fdiv\u003E\n\u003C\u002Ftd\u003E\n\u003Ctd class=\"content\"\u003E\nSi queremos conocer el tamaño exacto de las estructuras que vamos a utilizar, tenemos que especificar al compilador la forma de alinear la estructura en memoria, para ello utilizaremos la directiva \u003Ccode\u003E#pragma pack(n)\u003C\u002Fcode\u003E.\n\u003C\u002Ftd\u003E\n\u003C\u002Ftr\u003E\n\u003C\u002Ftable\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"sect1\"\u003E\n\u003Ch2 id=\"_la_directiva_pragma_pack_en_struct_c\"\u003ELa directiva #pragma pack en struct C++\u003C\u002Fh2\u003E\n\u003Cdiv class=\"sectionbody\"\u003E\n\u003Cdiv class=\"paragraph\"\u003E\n\u003Cp\u003ESe trata de una directiva del preprocesador que indica al compilador cómo debe realizar la alineación de la memoria.\u003C\u002Fp\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"listingblock\"\u003E\n\u003Cdiv class=\"title\"\u003EEjemplo con diferentes configuraciones de alineamiento de memoria\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"content\"\u003E\n\u003Cpre tabindex=\"0\" class=\"highlight\"\u003E\u003Ccode class=\"language-c++\" data-lang=\"c++\"\u003E\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Einclude\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-meta-string\"\u003E&lt;iostream&gt;\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"hljs-keyword\"\u003Eusing\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Enamespace\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003Estd\u003C\u002Fspan\u003E;\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Eprint\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-params\"\u003E(\u003Cspan class=\"hljs-keyword\"\u003Esize_t\u003C\u002Fspan\u003E sz, \u003Cspan class=\"hljs-keyword\"\u003Esize_t\u003C\u002Fspan\u003E sz_flag, \u003Cspan class=\"hljs-keyword\"\u003Esize_t\u003C\u002Fspan\u003E sz_timeout)\u003C\u002Fspan\u003E\n\u003C\u002Fspan\u003E{\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" flag: \"\u003C\u002Fspan\u003E &lt;&lt; sz_flag &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" Bytes\"\u003C\u002Fspan\u003E&lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" +\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" timeout: \"\u003C\u002Fspan\u003E &lt;&lt; sz_timeout &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"Bytes\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" =\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" \"\u003C\u002Fspan\u003E &lt;&lt; sz_timeout + sz_flag &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"Bytes\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" sizeof struct:  \"\u003C\u002Fspan\u003E &lt;&lt; sz &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" Bytes\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n}\n\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack (1)\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003ESampleStructPack1\u003C\u002Fspan\u003E\n{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-keyword\"\u003Ebool\u003C\u002Fspan\u003E flag;\n    \u003Cspan class=\"hljs-keyword\"\u003Eunsigned\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E timeout;\n};\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack(0)\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack (2)\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003ESampleStructPack2\u003C\u002Fspan\u003E\n{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-keyword\"\u003Ebool\u003C\u002Fspan\u003E flag;\n    \u003Cspan class=\"hljs-keyword\"\u003Eunsigned\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E timeout;\n};\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack(0)\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack (4)\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003ESampleStructPack4\u003C\u002Fspan\u003E\n{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-keyword\"\u003Ebool\u003C\u002Fspan\u003E flag;\n    \u003Cspan class=\"hljs-keyword\"\u003Eunsigned\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E timeout;\n};\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack(0)\u003C\u002Fspan\u003E\n\n\n\u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003ESampleStruct\u003C\u002Fspan\u003E\n{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-keyword\"\u003Ebool\u003C\u002Fspan\u003E flag;\n    \u003Cspan class=\"hljs-keyword\"\u003Eunsigned\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E timeout;\n};\n\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E(\u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E argc, \u003Cspan class=\"hljs-keyword\"\u003Echar\u003C\u002Fspan\u003E *argv[])\u003C\u002Fspan\u003E\n\u003C\u002Fspan\u003E{\n\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"SampleStructPack1\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Eprint\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStructPack1), \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStructPack1::flag), \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStructPack1::timeout));\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" -- \"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"SampleStructPack2\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Eprint\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStructPack2), \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStructPack2::flag), \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStructPack2::timeout));\n\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"SampleStructPack4\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Eprint\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStructPack4), \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStructPack4::flag), \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStructPack4::timeout));\n\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"SampleStruct\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n    \u003Cspan class=\"hljs-built_in\"\u003Eprint\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStruct), \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStruct::flag), \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(SampleStruct::timeout));\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" -- \"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n\n    \u003Cspan class=\"hljs-keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E;\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"listingblock\"\u003E\n\u003Cdiv class=\"title\"\u003E\u003Ca href=\"https:\u002F\u002Fcoliru.stacked-crooked.com\u002Fa\u002F7c18ee6585e57366\"\u003EEjecutando el código con las directivas pragma\u003C\u002Fa\u003E, tenemos distintos resultados dependiendo del valor de pragma.\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"content\"\u003E\n\u003Cpre tabindex=\"0\" class=\"highlight\"\u003E\u003Ccode class=\"language-bash\" data-lang=\"bash\"\u003ESampleStructPack1 \u003Cb class=\"conum\"\u003E(1)\u003C\u002Fb\u003E\n flag: 1 Bytes\n +\n timeout: 4Bytes\n =\n 5Bytes\n sizeof struct:  5 Bytes\n --\n\nSampleStructPack2 \u003Cb class=\"conum\"\u003E(2)\u003C\u002Fb\u003E\n flag: 1 Bytes\n +\n timeout: 4Bytes\n =\n 5Bytes\n sizeof struct:  6 Bytes\n\nSampleStructPack4 \u003Cb class=\"conum\"\u003E(3)\u003C\u002Fb\u003E\n flag: 1 Bytes\n +\n timeout: 4Bytes\n =\n 5Bytes\n sizeof struct:  8 Bytes\n\nSampleStruct \u003Cb class=\"conum\"\u003E(4)\u003C\u002Fb\u003E\n flag: 1 Bytes\n +\n timeout: 4Bytes\n =\n 5Bytes\n sizeof struct:  8 Bytes\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"colist arabic\"\u003E\n\u003Col\u003E\n\u003Cli\u003E\n\u003Cp\u003ESampleStructPack1 \u003Ccode\u003E#pragma pack (1)\u003C\u002Fcode\u003E: Reserva bloques de memoria de un byte, nuestra estructura se ha ajustado perfectamente; en este caso sí que \u003Ccode\u003E4 + 1 = 5\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Cp\u003ESampleStructPack2 \u003Ccode\u003E#pragma pack (2)\u003C\u002Fcode\u003E: Ahora el mínimo tamaño del bloque de memoria es de 2 bytes. Para el entero, hay un ajuste exacto porque necesita 2 bloques que 2 bytes para alojar sus 4 bytes. Para el caso del booleano, necesita un bloque de 1 byte, pero como mínimo tiene que asignar un bloque de 2 bytes, por eso en total reserva 6 bytes, \u003Ccode\u003E4 + 2 = 6\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Cp\u003ESampleStructPack4 \u003Ccode\u003E#pragma pack (4)\u003C\u002Fcode\u003E: Es el mismo caso que el anterior, aunque en el caso del booleano, hay un mayor \"desperdicio\" de memoria. Necesita 1 byte, pero reserva 4 bytes que es tamaño mínimo de bloque de memoria que puede asignar el compilador.\u003C\u002Fp\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Cp\u003ESampleStruct (default compiler alignment): Como vemos se comporta exactamente igual que \u003Ccode\u003E#pragma pack (4)\u003C\u002Fcode\u003E, podemos deducir que la alineación por defecto del compilador que estamos utilizando es de 4 bytes.\u003C\u002Fp\u003E\n\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"admonitionblock important\"\u003E\n\u003Ctable\u003E\n\u003Ctr\u003E\n\u003Ctd class=\"icon\"\u003E\n\u003Cdiv class=\"title\"\u003EImportant\u003C\u002Fdiv\u003E\n\u003C\u002Ftd\u003E\n\u003Ctd class=\"content\"\u003E\n¿Por qué no utilizamos siempre la alineación de memoria más ajustada (\u003Ccode\u003E#pragma pack (1)\u003C\u002Fcode\u003E) para aprovechar mejor la memoria?\n\u003C\u002Ftd\u003E\n\u003C\u002Ftr\u003E\n\u003C\u002Ftable\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"admonitionblock warning\"\u003E\n\u003Ctable\u003E\n\u003Ctr\u003E\n\u003Ctd class=\"icon\"\u003E\n\u003Cdiv class=\"title\"\u003EWarning\u003C\u002Fdiv\u003E\n\u003C\u002Ftd\u003E\n\u003Ctd class=\"content\"\u003E\nPorque perderemos rendimiento.\n\u003C\u002Ftd\u003E\n\u003C\u002Ftr\u003E\n\u003C\u002Ftable\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"sect1\"\u003E\n\u003Ch2 id=\"_rendimiento\"\u003ERendimiento\u003C\u002Fh2\u003E\n\u003Cdiv class=\"sectionbody\"\u003E\n\u003Cdiv class=\"paragraph\"\u003E\n\u003Cp\u003EVamos a hacer una prueba simple de rendimiento, en la que se va a reservar el mismo número de elementos en arrays para cada tipo de estructura.\u003C\u002Fp\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"paragraph\"\u003E\n\u003Cp\u003EEste es el resultado:\u003C\u002Fp\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"listingblock\"\u003E\n\u003Cdiv class=\"title\"\u003E\u003Ca href=\"https:\u002F\u002Fcoliru.stacked-crooked.com\u002Fa\u002F954ad542659c7591\"\u003EResultados de la prueba de rendimiento\u003C\u002Fa\u003E.\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"content\"\u003E\n\u003Cpre tabindex=\"0\" class=\"highlight\"\u003E\u003Ccode class=\"language-bash\" data-lang=\"bash\"\u003ESampleStructPack1: 500000000000000000 bytes allocated \u003Cspan class=\"hljs-keyword\"\u003Ein\u003C\u002Fspan\u003E 94311 nanoseconds\nSampleStructPack2: 600000000000000000 bytes allocated \u003Cspan class=\"hljs-keyword\"\u003Ein\u003C\u002Fspan\u003E 1777 nanoseconds\nSampleStructPack4: 800000000000000000 bytes allocated \u003Cspan class=\"hljs-keyword\"\u003Ein\u003C\u002Fspan\u003E 1519 nanoseconds\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"paragraph\"\u003E\n\u003Cp\u003EComo vemos cuanto más ajustada es la alineación de memoria, más tiempo se tarda en reservar y liberar.\u003C\u002Fp\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"paragraph\"\u003E\n\u003Cp\u003EA continuación pego el código de la prueba de rendimiento.\u003C\u002Fp\u003E\n\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"listingblock\"\u003E\n\u003Cdiv class=\"title\"\u003ECódigo de las pruebas de rendimiento\u003C\u002Fdiv\u003E\n\u003Cdiv class=\"content\"\u003E\n\u003Cpre tabindex=\"0\" class=\"highlight\"\u003E\u003Ccode class=\"language-c++\" data-lang=\"c++\"\u003E\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Einclude\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-meta-string\"\u003E&lt;iostream&gt;\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Einclude\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-meta-string\"\u003E&lt;chrono&gt;\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack (1)\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003ESampleStructPack1\u003C\u002Fspan\u003E\n{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-keyword\"\u003Ebool\u003C\u002Fspan\u003E flag;\n    \u003Cspan class=\"hljs-keyword\"\u003Eunsigned\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E timeout;\n};\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack(0)\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack (2)\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003ESampleStructPack2\u003C\u002Fspan\u003E\n{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-keyword\"\u003Ebool\u003C\u002Fspan\u003E flag;\n    \u003Cspan class=\"hljs-keyword\"\u003Eunsigned\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E timeout;\n};\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack(0)\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack (4)\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003ESampleStructPack4\u003C\u002Fspan\u003E\n{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-keyword\"\u003Ebool\u003C\u002Fspan\u003E flag;\n    \u003Cspan class=\"hljs-keyword\"\u003Eunsigned\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E timeout;\n};\n\u003Cspan class=\"hljs-meta\"\u003E#\u003Cspan class=\"hljs-meta-keyword\"\u003Epragma\u003C\u002Fspan\u003E pack(0)\u003C\u002Fspan\u003E\n\n\n\u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003ESampleStruct\u003C\u002Fspan\u003E\n{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-keyword\"\u003Ebool\u003C\u002Fspan\u003E flag;\n    \u003Cspan class=\"hljs-keyword\"\u003Eunsigned\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E timeout;\n};\n\n\u003Cspan class=\"hljs-keyword\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Elong\u003C\u002Fspan\u003E MAX_ELEMENTS = \u003Cspan class=\"hljs-number\"\u003E100000000000000000\u003C\u002Fspan\u003E;\n\u003Cspan class=\"hljs-keyword\"\u003Eusing\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Enamespace\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003Estd\u003C\u002Fspan\u003E;\n\u003Cspan class=\"hljs-keyword\"\u003Eusing\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Enamespace\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003Estd\u003C\u002Fspan\u003E::chrono;\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Eallocate1\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E()\u003C\u002Fspan\u003E\n\u003C\u002Fspan\u003E{\n    SampleStructPack1 elements [MAX_ELEMENTS];\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"SampleStructPack1: \"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(elements) &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" bytes allocated\"\u003C\u002Fspan\u003E;\n}\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Eallocate2\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E()\u003C\u002Fspan\u003E\n\u003C\u002Fspan\u003E{\n    SampleStructPack2 elements [MAX_ELEMENTS];\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"SampleStructPack2: \"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(elements) &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" bytes allocated\"\u003C\u002Fspan\u003E;\n}\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Eallocate4\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E()\u003C\u002Fspan\u003E\n\u003C\u002Fspan\u003E{\n    SampleStructPack4 elements [MAX_ELEMENTS];\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\"SampleStructPack4: \"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-keyword\"\u003Esizeof\u003C\u002Fspan\u003E(elements) &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" bytes allocated\"\u003C\u002Fspan\u003E;\n}\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Echrono1\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E()\u003C\u002Fspan\u003E\n\u003C\u002Fspan\u003E{\n    \u003Cspan class=\"hljs-keyword\"\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003Ebegin\u003C\u002Fspan\u003E = high_resolution_clock::now() ;\n    allocate1();\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" in \"\u003C\u002Fspan\u003E &lt;&lt; duration_cast&lt;nanoseconds&gt;(high_resolution_clock::now() - \u003Cspan class=\"hljs-built_in\"\u003Ebegin\u003C\u002Fspan\u003E).count() &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" nanoseconds\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n}\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Echrono2\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E()\u003C\u002Fspan\u003E\n\u003C\u002Fspan\u003E{\n    \u003Cspan class=\"hljs-keyword\"\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003Ebegin\u003C\u002Fspan\u003E = high_resolution_clock::now() ;\n    allocate2();\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" in \"\u003C\u002Fspan\u003E &lt;&lt; duration_cast&lt;nanoseconds&gt;(high_resolution_clock::now() - \u003Cspan class=\"hljs-built_in\"\u003Ebegin\u003C\u002Fspan\u003E).count() &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" nanoseconds\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n}\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Echrono4\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E()\u003C\u002Fspan\u003E\n\u003C\u002Fspan\u003E{\n    \u003Cspan class=\"hljs-keyword\"\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003Ebegin\u003C\u002Fspan\u003E = high_resolution_clock::now() ;\n    allocate4();\n    \u003Cspan class=\"hljs-built_in\"\u003Ecout\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" in \"\u003C\u002Fspan\u003E &lt;&lt; duration_cast&lt;nanoseconds&gt;(high_resolution_clock::now() - \u003Cspan class=\"hljs-built_in\"\u003Ebegin\u003C\u002Fspan\u003E).count() &lt;&lt; \u003Cspan class=\"hljs-string\"\u003E\" nanoseconds\"\u003C\u002Fspan\u003E &lt;&lt; \u003Cspan class=\"hljs-built_in\"\u003Eendl\u003C\u002Fspan\u003E;\n}\n\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E(\u003Cspan class=\"hljs-keyword\"\u003Eint\u003C\u002Fspan\u003E argc, \u003Cspan class=\"hljs-keyword\"\u003Echar\u003C\u002Fspan\u003E *argv[])\u003C\u002Fspan\u003E\n\u003C\u002Fspan\u003E{\n    chrono1();\n    chrono2();\n    chrono4();\n\n    \u003Cspan class=\"hljs-keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E;\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E",post:{title:"Alineación de una Estructura C++ en Memoria",lang:"es",summary:"Comprendiendo cómo funciona la directiva C++ pragma pack y cómo afecta a la alineación de la memoria",slug:"cpp-pragma-pack",keywords:["C++","Performance","Compilers","Memory"],filename:"cpp-pragma-pack.es.adoc",modified:a,created:a,author:"Carlos Martin Sanchez",previewimage:"\u002Fimages\u002Fc-mem-struct\u002F5b.png",otherLangs:["en"],path:b,url:"https:\u002F\u002Fcarlosvin.github.io\u002Fposts\u002Fcpp-pragma-pack\u002Fes"},postPath:b}}(1353927600000,"\u002Fposts\u002Fcpp-pragma-pack\u002Fes"))]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');var s=document.createElement("script");try{new Function("if(0)import('')")();s.src="/client/client.e893ff6a.js";s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@1.0.1.js";s.setAttribute("data-main","/client/client.e893ff6a.js")}document.head.appendChild(s)</script> <link href=client/client-518dbade.css rel=stylesheet><link href=client/Details-78b1caad.css rel=stylesheet><link href=client/[...slug]-b7ff5a61.css rel=stylesheet> <link href=/client/client-518dbade.css rel=preload as=style><link href=/client/Details-78b1caad.css rel=preload as=style><link href=/client/[...slug]-b7ff5a61.css rel=preload as=style></head> <body> <div id=sapper> <nav class=svelte-1hjvhrx><ul class=svelte-1hjvhrx><li class=svelte-1y8uoef><a href=/ class=svelte-1y8uoef rel=prefetch><img alt="Carlos says bla bla logo" src=/favicon.png class="svelte-1hjvhrx logo"></a></ul> <ul class="svelte-1hjvhrx closed"><li class=svelte-1y8uoef><a href=/ class=svelte-1y8uoef rel=prefetch><span class="svelte-1hjvhrx siteName">Carlos says bla bla</span></a></li> <li class=svelte-1y8uoef><a href=/categories class=svelte-1y8uoef rel=prefetch>Categories</a></li> <li class=svelte-1y8uoef><a href=/about class=svelte-1y8uoef rel=prefetch>About</a></ul> <div class="h svelte-1w8skyw"><a href=/feeds class="icon svelte-1lu397 rss" rel=noopener aria-label="Subscribe to Carlos says bla bla" target=_blank title="Subscribe to Carlos says bla bla"></a> <a href=https://github.com/carlosvin class="icon svelte-1lu397 github" rel=noopener aria-label="Find me at github" target=_blank title="Find me at github"></a> <a href=https://twitter.com/carlosvin class="icon svelte-1lu397 twitter" rel=noopener aria-label="Find me at twitter" target=_blank title="Find me at twitter"></a> <a href=https://stackoverflow.com/story/carlosvin class="icon svelte-1lu397 stackoverflow" rel=noopener aria-label="Find me at stackoverflow" target=_blank title="Find me at stackoverflow"></a></div> <button class=svelte-1hjvhrx type=button>≡</button></nav> <main class=svelte-bvcji9> <header class=svelte-5fppzy><h1 class=svelte-5fppzy>Alineación de una Estructura C++ en Memoria <span class="svelte-5fppzy share"><a href="https://twitter.com/intent/tweet?url=https://carlosvin.github.io/posts/cpp-pragma-pack/es&text=Alineación de una Estructura C++ en Memoria:&amp;nbsp;Comprendiendo cómo funciona la directiva C++ pragma pack y cómo afecta a la alineación de la memoria&hashtags=C++,Performance,Compilers,Memory" class="icon svelte-1lu397 twitter" rel=noopener aria-label='Share "Alineación de una Estructura C++ en Memoria"' target=_blank title='Share "Alineación de una Estructura C++ en Memoria"'></a></span></h1> <p class="svelte-5fppzy summary">Comprendiendo cómo funciona la directiva C++ pragma pack y cómo afecta a la alineación de la memoria</p> <div class="subtitle svelte-16mbbpz"><span class=date>26/11/2012</span> <span class="summary langs">Available in <span class="lang svelte-k3ijyt"><a href=/posts/cpp-pragma-pack/en rel=alternate hreflang=en>en</a> </span></span> <span class="svelte-9pgfi9 tags"><a href=/categories/c class=svelte-1ci4az4 title=C++><span class="hover svelte-askwsu">C++</span></a><a href=/categories/performance class=svelte-1ci4az4 title=Performance><span class="hover svelte-askwsu">Performance</span></a><a href=/categories/compilers class=svelte-1ci4az4 title=Compilers><span class="hover svelte-askwsu">Compilers</span></a><a href=/categories/memory class=svelte-1ci4az4 title=Memory><span class="hover svelte-askwsu">Memory</span></a></span></div></header> <div class="content svelte-101opq9"><div class=toc id=toc> <div id=toctitle>Table of Contents</div> <ul class=sectlevel1> <li><a href=#_estructura_de_ejemplo>Estructura de ejemplo</a></li> <li><a href=#_la_directiva_pragma_pack_en_struct_c>La directiva #pragma pack en struct C++</a></li> <li><a href=#_rendimiento>Rendimiento</a></li> </ul> </div> <div id=preamble> <div class=sectionbody> <div class=paragraph> <p>Un struct de C++ es un elemento que permite agrupar elementos de tipos distintos con alguna relación entre ellos. Esto permite manipular todos los elementos en bloque mediante una única referencia. Podemos considerarlo como una clase con visibilidad publica por defecto para sus atributos y funciones.</p> </div> <div class=paragraph> <p>Si alguna vez nos interesa trabajar a un nivel más bajo, nos puede resultar útil entender cómo se mapea una estructura en memoria y cómo controlar este mapeo.</p> </div> </div> </div> <div class=sect1> <h2 id=_estructura_de_ejemplo>Estructura de ejemplo</h2> <div class=sectionbody> <div class=paragraph> <p>Esta estructura estará compuesta por dos campos, un entero (4 bytes) y un booleano (un byte). En C++ queda de la siguiente forma:</p> </div> <div class=listingblock> <div class=content> <pre class=highlight tabindex=0><code class=language-c++ data-lang=c++><span class=hljs-class><span class=hljs-keyword>struct</span> <span class=hljs-title>SampleStruct</span>
{</span>
    <span class=hljs-keyword>bool</span> flag;
    <span class=hljs-keyword>unsigned</span> <span class=hljs-keyword>int</span> timeout;
};</code></pre> </div> </div> <div class=paragraph> <p>Si hacemos un <code>sizeof</code> de una instancia de la estructura deberíamos obtener un tamaño de 5 bytes. Y la memoria quedaría de la siguiente forma:</p> </div> <div class="center imageblock" id=5-bytes> <div class=content> <img alt=5Bytes src=/images/c-mem-struct/5b.png height=auto width=200> </div> <div class=title>Figure 1. Estructura de 5 bytes que realmente ocupa 5 bytes en memoria</div> </div> <div class=paragraph> <p><strong>Pero</strong> no es tan sencillo, a continuación veremos que no nos podemos olvidar de la alineación de la memoria que hace el compilador en ese sistema y veremos cómo controlarlo para no encontrarnos con tamaños inesperados, ya que esto depende del compilador del sistema.</p> </div> <div class=paragraph> <p>Por ejemplo, si en mi máquina hago un <code>sizeof</code> de la estructura de ejemplo, <strong>obtengo un tamaño de 8 bytes</strong>. Lo que está sucediendo es que el compilador reserva más memoria al final de la estructura para que cuadre en bloques de 2n Bytes. La memoria realmente queda de la siguiente forma:</p> </div> <div class="center imageblock" id=8-bytes> <div class=content> <img alt=5Bytes src=/images/c-mem-struct/8b.png height=auto width=200> </div> <div class=title>Sin pragma: Estructura de 5 Bytes que realmente ocupa 8 Bytes en memoria</div> </div> <div class=listingblock> <div class=title>Fragmento de código que imprime el tamaño de la estructura y el de cada uno de sus atributos, en este caso 4 + 1 no es 5</div> <div class=content> <pre class=highlight tabindex=0><code class=language-c++ data-lang=c++><span class=hljs-meta>#<span class=hljs-meta-keyword>include</span>  <span class=hljs-meta-string>&lt;iostream></span></span>

<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>;

<span class=hljs-class><span class=hljs-keyword>struct</span> <span class=hljs-title>SampleStruct</span>
{</span>
    <span class=hljs-keyword>bool</span> flag;
    <span class=hljs-keyword>unsigned</span> <span class=hljs-keyword>int</span> timeout;
};

<span class=hljs-function><span class=hljs-keyword>static</span> <span class=hljs-keyword>void</span> <span class=hljs-title>print</span> <span class=hljs-params>(<span class=hljs-keyword>size_t</span> sz, <span class=hljs-keyword>size_t</span> sz_flag, <span class=hljs-keyword>size_t</span> sz_timeout)</span>
</span>{
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"\tflag: "</span> &lt;&lt; sz_flag &lt;&lt; <span class=hljs-string>" Bytes"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"\t+"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"\ttimeout: "</span> &lt;&lt; sz_timeout &lt;&lt; <span class=hljs-string>" Bytes"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"\t="</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"\t"</span> &lt;&lt; sz_timeout + sz_flag &lt;&lt; <span class=hljs-string>" Bytes"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt;<span class=hljs-string>"sizeof struct:  "</span> &lt;&lt; sz &lt;&lt; <span class=hljs-string>" Bytes"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
}

<span class=hljs-function><span class=hljs-keyword>int</span> <span class=hljs-title>main</span><span class=hljs-params>(<span class=hljs-keyword>int</span> argc, <span class=hljs-keyword>char</span> *argv[])</span>
</span>{
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"SampleStruct"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>print</span> (<span class=hljs-keyword>sizeof</span>(SampleStruct), <span class=hljs-keyword>sizeof</span>(SampleStruct::flag), <span class=hljs-keyword>sizeof</span>(SampleStruct::timeout));
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" -- "</span> &lt;&lt; <span class=hljs-built_in>endl</span>;

    <span class=hljs-keyword>return</span> <span class=hljs-number>0</span>;
}</code></pre> </div> </div> <div class=listingblock> <div class=title><a href=https://coliru.stacked-crooked.com/a/c7deb3df49bebd40>Ejecutando el código sin la directiva pragma</a>, tenemos que nuestra estructura ocupa 8 bytes en lugar de 5 bytes.</div> <div class=content> <pre class=highlight tabindex=0><code class=language-bash data-lang=bash>SampleStruct
flag: 1 Bytes
+
timeout: 4 Bytes
=
5 Bytes
sizeof struct:  8 Bytes
--</code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class=icon> <div class=title>Tip</div> </td> <td class=content> Si queremos conocer el tamaño exacto de las estructuras que vamos a utilizar, tenemos que especificar al compilador la forma de alinear la estructura en memoria, para ello utilizaremos la directiva <code>#pragma pack(n)</code>. </td> </tr> </table> </div> </div> </div> <div class=sect1> <h2 id=_la_directiva_pragma_pack_en_struct_c>La directiva #pragma pack en struct C++</h2> <div class=sectionbody> <div class=paragraph> <p>Se trata de una directiva del preprocesador que indica al compilador cómo debe realizar la alineación de la memoria.</p> </div> <div class=listingblock> <div class=title>Ejemplo con diferentes configuraciones de alineamiento de memoria</div> <div class=content> <pre class=highlight tabindex=0><code class=language-c++ data-lang=c++><span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;iostream></span></span>

<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>;

<span class=hljs-function><span class=hljs-keyword>static</span> <span class=hljs-keyword>void</span> <span class=hljs-title>print</span> <span class=hljs-params>(<span class=hljs-keyword>size_t</span> sz, <span class=hljs-keyword>size_t</span> sz_flag, <span class=hljs-keyword>size_t</span> sz_timeout)</span>
</span>{
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" flag: "</span> &lt;&lt; sz_flag &lt;&lt; <span class=hljs-string>" Bytes"</span>&lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" +"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" timeout: "</span> &lt;&lt; sz_timeout &lt;&lt; <span class=hljs-string>"Bytes"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" ="</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" "</span> &lt;&lt; sz_timeout + sz_flag &lt;&lt; <span class=hljs-string>"Bytes"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" sizeof struct:  "</span> &lt;&lt; sz &lt;&lt; <span class=hljs-string>" Bytes"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
}

<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack (1)</span>
<span class=hljs-class><span class=hljs-keyword>struct</span> <span class=hljs-title>SampleStructPack1</span>
{</span>
    <span class=hljs-keyword>bool</span> flag;
    <span class=hljs-keyword>unsigned</span> <span class=hljs-keyword>int</span> timeout;
};
<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack(0)</span>

<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack (2)</span>
<span class=hljs-class><span class=hljs-keyword>struct</span> <span class=hljs-title>SampleStructPack2</span>
{</span>
    <span class=hljs-keyword>bool</span> flag;
    <span class=hljs-keyword>unsigned</span> <span class=hljs-keyword>int</span> timeout;
};
<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack(0)</span>

<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack (4)</span>
<span class=hljs-class><span class=hljs-keyword>struct</span> <span class=hljs-title>SampleStructPack4</span>
{</span>
    <span class=hljs-keyword>bool</span> flag;
    <span class=hljs-keyword>unsigned</span> <span class=hljs-keyword>int</span> timeout;
};
<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack(0)</span>


<span class=hljs-class><span class=hljs-keyword>struct</span> <span class=hljs-title>SampleStruct</span>
{</span>
    <span class=hljs-keyword>bool</span> flag;
    <span class=hljs-keyword>unsigned</span> <span class=hljs-keyword>int</span> timeout;
};


<span class=hljs-function><span class=hljs-keyword>int</span> <span class=hljs-title>main</span><span class=hljs-params>(<span class=hljs-keyword>int</span> argc, <span class=hljs-keyword>char</span> *argv[])</span>
</span>{

    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"SampleStructPack1"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>print</span> (<span class=hljs-keyword>sizeof</span>(SampleStructPack1), <span class=hljs-keyword>sizeof</span>(SampleStructPack1::flag), <span class=hljs-keyword>sizeof</span>(SampleStructPack1::timeout));
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" -- "</span> &lt;&lt; <span class=hljs-built_in>endl</span>;

    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"SampleStructPack2"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>print</span> (<span class=hljs-keyword>sizeof</span>(SampleStructPack2), <span class=hljs-keyword>sizeof</span>(SampleStructPack2::flag), <span class=hljs-keyword>sizeof</span>(SampleStructPack2::timeout));

    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"SampleStructPack4"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>print</span> (<span class=hljs-keyword>sizeof</span>(SampleStructPack4), <span class=hljs-keyword>sizeof</span>(SampleStructPack4::flag), <span class=hljs-keyword>sizeof</span>(SampleStructPack4::timeout));

    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"SampleStruct"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
    <span class=hljs-built_in>print</span> (<span class=hljs-keyword>sizeof</span>(SampleStruct), <span class=hljs-keyword>sizeof</span>(SampleStruct::flag), <span class=hljs-keyword>sizeof</span>(SampleStruct::timeout));
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" -- "</span> &lt;&lt; <span class=hljs-built_in>endl</span>;

    <span class=hljs-keyword>return</span> <span class=hljs-number>0</span>;
}</code></pre> </div> </div> <div class=listingblock> <div class=title><a href=https://coliru.stacked-crooked.com/a/7c18ee6585e57366>Ejecutando el código con las directivas pragma</a>, tenemos distintos resultados dependiendo del valor de pragma.</div> <div class=content> <pre class=highlight tabindex=0><code class=language-bash data-lang=bash>SampleStructPack1 <b class=conum>(1)</b>
 flag: 1 Bytes
 +
 timeout: 4Bytes
 =
 5Bytes
 sizeof struct:  5 Bytes
 --

SampleStructPack2 <b class=conum>(2)</b>
 flag: 1 Bytes
 +
 timeout: 4Bytes
 =
 5Bytes
 sizeof struct:  6 Bytes

SampleStructPack4 <b class=conum>(3)</b>
 flag: 1 Bytes
 +
 timeout: 4Bytes
 =
 5Bytes
 sizeof struct:  8 Bytes

SampleStruct <b class=conum>(4)</b>
 flag: 1 Bytes
 +
 timeout: 4Bytes
 =
 5Bytes
 sizeof struct:  8 Bytes</code></pre> </div> </div> <div class="arabic colist"> <ol> <li> <p>SampleStructPack1 <code>#pragma pack (1)</code>: Reserva bloques de memoria de un byte, nuestra estructura se ha ajustado perfectamente; en este caso sí que <code>4 + 1 = 5</code>.</p> </li> <li> <p>SampleStructPack2 <code>#pragma pack (2)</code>: Ahora el mínimo tamaño del bloque de memoria es de 2 bytes. Para el entero, hay un ajuste exacto porque necesita 2 bloques que 2 bytes para alojar sus 4 bytes. Para el caso del booleano, necesita un bloque de 1 byte, pero como mínimo tiene que asignar un bloque de 2 bytes, por eso en total reserva 6 bytes, <code>4 + 2 = 6</code>.</p> </li> <li> <p>SampleStructPack4 <code>#pragma pack (4)</code>: Es el mismo caso que el anterior, aunque en el caso del booleano, hay un mayor "desperdicio" de memoria. Necesita 1 byte, pero reserva 4 bytes que es tamaño mínimo de bloque de memoria que puede asignar el compilador.</p> </li> <li> <p>SampleStruct (default compiler alignment): Como vemos se comporta exactamente igual que <code>#pragma pack (4)</code>, podemos deducir que la alineación por defecto del compilador que estamos utilizando es de 4 bytes.</p> </li> </ol> </div> <div class="admonitionblock important"> <table> <tr> <td class=icon> <div class=title>Important</div> </td> <td class=content> ¿Por qué no utilizamos siempre la alineación de memoria más ajustada (<code>#pragma pack (1)</code>) para aprovechar mejor la memoria? </td> </tr> </table> </div> <div class="admonitionblock warning"> <table> <tr> <td class=icon> <div class=title>Warning</div> </td> <td class=content> Porque perderemos rendimiento. </td> </tr> </table> </div> </div> </div> <div class=sect1> <h2 id=_rendimiento>Rendimiento</h2> <div class=sectionbody> <div class=paragraph> <p>Vamos a hacer una prueba simple de rendimiento, en la que se va a reservar el mismo número de elementos en arrays para cada tipo de estructura.</p> </div> <div class=paragraph> <p>Este es el resultado:</p> </div> <div class=listingblock> <div class=title><a href=https://coliru.stacked-crooked.com/a/954ad542659c7591>Resultados de la prueba de rendimiento</a>.</div> <div class=content> <pre class=highlight tabindex=0><code class=language-bash data-lang=bash>SampleStructPack1: 500000000000000000 bytes allocated <span class=hljs-keyword>in</span> 94311 nanoseconds
SampleStructPack2: 600000000000000000 bytes allocated <span class=hljs-keyword>in</span> 1777 nanoseconds
SampleStructPack4: 800000000000000000 bytes allocated <span class=hljs-keyword>in</span> 1519 nanoseconds</code></pre> </div> </div> <div class=paragraph> <p>Como vemos cuanto más ajustada es la alineación de memoria, más tiempo se tarda en reservar y liberar.</p> </div> <div class=paragraph> <p>A continuación pego el código de la prueba de rendimiento.</p> </div> <div class=listingblock> <div class=title>Código de las pruebas de rendimiento</div> <div class=content> <pre class=highlight tabindex=0><code class=language-c++ data-lang=c++><span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;iostream></span></span>
<span class=hljs-meta>#<span class=hljs-meta-keyword>include</span> <span class=hljs-meta-string>&lt;chrono></span></span>

<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack (1)</span>
<span class=hljs-class><span class=hljs-keyword>struct</span> <span class=hljs-title>SampleStructPack1</span>
{</span>
    <span class=hljs-keyword>bool</span> flag;
    <span class=hljs-keyword>unsigned</span> <span class=hljs-keyword>int</span> timeout;
};
<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack(0)</span>

<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack (2)</span>
<span class=hljs-class><span class=hljs-keyword>struct</span> <span class=hljs-title>SampleStructPack2</span>
{</span>
    <span class=hljs-keyword>bool</span> flag;
    <span class=hljs-keyword>unsigned</span> <span class=hljs-keyword>int</span> timeout;
};
<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack(0)</span>

<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack (4)</span>
<span class=hljs-class><span class=hljs-keyword>struct</span> <span class=hljs-title>SampleStructPack4</span>
{</span>
    <span class=hljs-keyword>bool</span> flag;
    <span class=hljs-keyword>unsigned</span> <span class=hljs-keyword>int</span> timeout;
};
<span class=hljs-meta>#<span class=hljs-meta-keyword>pragma</span> pack(0)</span>


<span class=hljs-class><span class=hljs-keyword>struct</span> <span class=hljs-title>SampleStruct</span>
{</span>
    <span class=hljs-keyword>bool</span> flag;
    <span class=hljs-keyword>unsigned</span> <span class=hljs-keyword>int</span> timeout;
};

<span class=hljs-keyword>static</span> <span class=hljs-keyword>const</span> <span class=hljs-keyword>long</span> MAX_ELEMENTS = <span class=hljs-number>100000000000000000</span>;
<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>;
<span class=hljs-keyword>using</span> <span class=hljs-keyword>namespace</span> <span class=hljs-built_in>std</span>::chrono;

<span class=hljs-function><span class=hljs-keyword>void</span> <span class=hljs-title>allocate1</span><span class=hljs-params>()</span>
</span>{
    SampleStructPack1 elements [MAX_ELEMENTS];
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"SampleStructPack1: "</span> &lt;&lt; <span class=hljs-keyword>sizeof</span>(elements) &lt;&lt; <span class=hljs-string>" bytes allocated"</span>;
}

<span class=hljs-function><span class=hljs-keyword>void</span> <span class=hljs-title>allocate2</span><span class=hljs-params>()</span>
</span>{
    SampleStructPack2 elements [MAX_ELEMENTS];
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"SampleStructPack2: "</span> &lt;&lt; <span class=hljs-keyword>sizeof</span>(elements) &lt;&lt; <span class=hljs-string>" bytes allocated"</span>;
}

<span class=hljs-function><span class=hljs-keyword>void</span> <span class=hljs-title>allocate4</span><span class=hljs-params>()</span>
</span>{
    SampleStructPack4 elements [MAX_ELEMENTS];
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>"SampleStructPack4: "</span> &lt;&lt; <span class=hljs-keyword>sizeof</span>(elements) &lt;&lt; <span class=hljs-string>" bytes allocated"</span>;
}

<span class=hljs-function><span class=hljs-keyword>void</span> <span class=hljs-title>chrono1</span><span class=hljs-params>()</span>
</span>{
    <span class=hljs-keyword>auto</span> <span class=hljs-built_in>begin</span> = high_resolution_clock::now() ;
    allocate1();
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" in "</span> &lt;&lt; duration_cast&lt;nanoseconds>(high_resolution_clock::now() - <span class=hljs-built_in>begin</span>).count() &lt;&lt; <span class=hljs-string>" nanoseconds"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
}

<span class=hljs-function><span class=hljs-keyword>void</span> <span class=hljs-title>chrono2</span><span class=hljs-params>()</span>
</span>{
    <span class=hljs-keyword>auto</span> <span class=hljs-built_in>begin</span> = high_resolution_clock::now() ;
    allocate2();
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" in "</span> &lt;&lt; duration_cast&lt;nanoseconds>(high_resolution_clock::now() - <span class=hljs-built_in>begin</span>).count() &lt;&lt; <span class=hljs-string>" nanoseconds"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
}

<span class=hljs-function><span class=hljs-keyword>void</span> <span class=hljs-title>chrono4</span><span class=hljs-params>()</span>
</span>{
    <span class=hljs-keyword>auto</span> <span class=hljs-built_in>begin</span> = high_resolution_clock::now() ;
    allocate4();
    <span class=hljs-built_in>cout</span> &lt;&lt; <span class=hljs-string>" in "</span> &lt;&lt; duration_cast&lt;nanoseconds>(high_resolution_clock::now() - <span class=hljs-built_in>begin</span>).count() &lt;&lt; <span class=hljs-string>" nanoseconds"</span> &lt;&lt; <span class=hljs-built_in>endl</span>;
}


<span class=hljs-function><span class=hljs-keyword>int</span> <span class=hljs-title>main</span><span class=hljs-params>(<span class=hljs-keyword>int</span> argc, <span class=hljs-keyword>char</span> *argv[])</span>
</span>{
    chrono1();
    chrono2();
    chrono4();

    <span class=hljs-keyword>return</span> <span class=hljs-number>0</span>;
}</code></pre> </div> </div> </div> </div></div></main> </div> 